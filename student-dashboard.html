<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - Fortitude Frontier</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
        /* Custom CSS for Fortitude Frontier - Orange & Black Theme */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0D0D0D; /* Background: Very dark grey/black */
            color: #FFFFFF; /* On-Background/On-Surface: White text */
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Custom styles for consistent look with main page */
        .action-button {
            background-color: #FF8C00; /* Vibrant Orange */
            color: #0D0D0D; /* On-Primary: Dark text */
            transition: background-color 0.3s ease, transform 0.2s ease;
            border-radius: 9999px; /* Fully rounded for sleek look */
            padding: 0.75rem 1.5rem; /* More generous padding */
            font-weight: 700; /* Extra bold */
        }

        .action-button:hover {
            background-color: #FF7F00; /* Darker Orange on hover */
            transform: translateY(-2px) scale(1.02); /* Slight lift and scale */
            color: #FFFFFF; /* On-Secondary: White text */
        }

        /* Scrollbar styles */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #f97316; /* Orange-500 */
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #ea580c; /* Orange-600 */
        }
        #logoimg{
           height: 10vh;
           padding: 0;
           filter: drop-shadow(0 0 5px rgba(255,140,0,0.5)); /* Subtle logo glow */
        }

        /* Modal styling */
        .modal {
            position: fixed;
            z-index: 9997;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.85); /* Slightly darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.4s ease, visibility 0.4s ease; /* Slower, smoother transition */
        }
        .modal.show {
            visibility: visible;
            opacity: 1;
        }
        .modal-content {
            background-color: #1A1A1A;
            margin: auto;
            padding: 2.5rem;
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 8px 25px rgba(0,0,0,0.6); /* Stronger, deeper shadow */
            width: 90%;
            max-width: 550px; /* Slightly wider modal */
            position: relative;
            transform: translateY(-30px) scale(0.95); /* More pronounced entry animation */
            transition: transform 0.4s ease, opacity 0.4s ease;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid #333; /* Subtle border */
        }
        .modal.show .modal-content {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
        .close-button {
            color: #FFFFFF;
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            font-size: 2.2rem; /* Larger close button */
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .close-button:hover,
        .close-button:focus {
            color: #FF8C00;
            transform: rotate(90deg); /* Rotate on hover */
        }
        /* Message box styling */
        .message-box {
            background-color: #2A2A2A;
            color: #FFFFFF;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            text-align: center;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9998;
            min-width: 300px;
            max-width: 90%;
            display: none; /* Hidden by default */
            animation: fadeIn 0.3s ease-out; /* Add fade in animation */
        }
        .message-box.show {
            display: block;
        }
        .message-box button {
            margin-top: 1rem;
            background-color: #FF8C00;
            color: #0D0D0D;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .message-box button:hover {
            background-color: #FF7F00;
            transform: scale(1.05);
        }

        /* Card Hover Animations */
        .dashboard-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
            border: 1px solid rgba(255, 140, 0, 0.1); /* Subtle border */
        }
        .dashboard-card:hover {
            transform: translateY(-8px) scale(1.03); /* More pronounced lift and scale */
            box-shadow: 0 12px 25px rgba(255, 140, 0, 0.3); /* Stronger orange glow */
            background-color: #3A3A3A; /* Slightly lighter on hover */
        }

        .list-item {
            transition: background-color 0.2s ease, transform 0.1s ease;
            border-radius: 0.75rem; /* More rounded list items */
            overflow: hidden; /* Ensure content fits */
        }
        .list-item:hover {
            background-color: #3a3a3a !important; /* Slightly lighter dark gray on hover */
            transform: translateX(5px); /* Slide effect on hover */
        }

        /* Specific section colors for icons/headers */
        .section-header-feedback { color: #60A5FA; /* Blue */ }
        .section-header-attendance { color: #10B981; /* Green */ }
        .section-header-sessions { color: #EAB308; /* Yellow */ }

        .icon-feedback { color: #60A5FA; }
        .icon-attendance { color: #10B981; }
        .icon-sessions { color: #EAB308; }
        .icon-notes { color: #9B59B6; /* Purple */ } /* Added specific notes icon color */

        /* NEW: Feedback item styling for cool look */
        .feedback-item-card {
            background-color: #3a3a3a; /* Slightly lighter background for the card */
            border-left: 6px solid #60A5FA; /* Thicker accent border on the left */
            padding: 1.2rem 1.8rem; /* More padding */
            border-radius: 0.75rem; /* Consistent border-radius */
            box-shadow: 0 4px 12px rgba(0,0,0,0.25); /* Enhanced shadow */
            position: relative;
            overflow: hidden;
            animation: fadeIn 0.6s ease-out forwards; /* Slower fade in animation */
            margin-bottom: 0.75rem; /* Space between cards */
        }
        .feedback-item-card:last-child {
            margin-bottom: 0; /* No margin for the last one */
        }
        .feedback-item-card:before {
            content: "\f075"; /* Font Awesome comment icon */
            font-family: 'FontAwesome';
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 3.5em; /* Larger icon */
            color: rgba(96, 165, 250, 0.15); /* Slightly more faded blue */
            z-index: 0;
            pointer-events: none;
            transform: rotate(-10deg); /* Slight rotation for dynamic feel */
        }
        .feedback-item-card p {
            position: relative; /* Ensure text is above pseudo-element */
            z-index: 1;
        }
        .feedback-item-card .feedback-text {
            color: #E2E8F0; /* Lighter text for contrast */
            font-size: 1.15rem; /* Slightly larger text */
            margin-bottom: 0.6rem; /* More space */
            line-height: 1.5; /* Better line spacing */
        }
        .feedback-item-card .feedback-timestamp {
            color: #B0B9C4; /* A bit lighter gray for timestamp */
            font-size: 0.9rem; /* Slightly larger timestamp */
            font-style: italic;
        }

        /* Animation for sections appearing */
        .fade-in-section {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }
        .fade-in-section.is-visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Specific styling for attendance status */
        .status-present { color: #34D399; /* Emerald Green */ }
        .status-absent { color: #EF4444; /* Red */ }
        .status-late { color: #FBBF24; /* Amber Yellow */ }


        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); } /* More movement on fade-in */
            to { opacity: 1; transform: translateY(0); }
        }
         @keyframes headerGlow {
            0% { text-shadow: 0 0 5px rgba(255, 140, 0, 0.5); }
            50% { text-shadow: 0 0 15px rgba(255, 140, 0, 0.8); }
            100% { text-shadow: 0 0 5px rgba(255, 140, 0, 0.5); }
        }
        .glowing-header {
            animation: headerGlow 3s infinite alternate; /* Apply glowing effect */
        }
    </style>
</head>
<body class="bg-[#0D0D0D] text-white">

    <!-- Message Box for Alerts/Confirmations -->
    <div id="custom-message-box" class="message-box">
        <p id="message-box-text" class="text-lg mb-4"></p>
        <button id="message-box-confirm-btn">OK</button>
    </div>

    <!-- Student Login Modal -->
    <div id="student-login-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="student-login-close-button">&times;</span>
            <h3 class="text-3xl font-bold text-[#FF8C00] mb-6 text-center">Student Login</h3>
            <form id="student-auth-form" class="space-y-4">
                <div>
                    <label for="student-email" class="block text-lg font-medium text-orange-300 mb-2">Email:</label>
                    <input type="email" id="student-email" class="w-full p-3 rounded-md bg-[#0D0D0D] text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#FF8C00]" placeholder="your.email@example.com" required>
                </div>
                <div>
                    <label for="student-password" class="block text-lg font-medium text-orange-300 mb-2">Password:</label>
                    <input type="password" id="student-password" class="w-full p-3 rounded-md bg-[#0D0D0D] text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#FF8C00]" placeholder="********" required>
                </div>
                <button type="submit" id="student-login-btn" class="w-full action-button font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">Login as Student</button>
                <p id="student-auth-message" class="text-center text-sm mt-4 text-red-400 hidden"></p>
            </form>
        </div>
    </div>

    <div class="min-h-screen flex flex-col py-10 px-4">
        <!-- Navbar for Student Dashboard Page -->
        <nav class="p-6 md:bg-[#1A1A1A] shadow-lg fixed top-0 w-full z-50">
            <div class="container flex justify-between items-center">
                <a href="index.html" class="md:text-xl"><img src="fflogo-removebg-preview.png" id="logoimg" alt="Fortitude Frontier Logo"></a>
                <div class="hidden sm:flex flex-wrap justify-end items-center sm:gap-x-4 sm:gap-y-2">
                    <a href="index.html" class="nav-link text-lg text-[#FFFFFF] hover:text-white transition duration-300">Home</a>
                    <a href="index.html#quizzes" class="nav-link text-lg text-[#FFFFFF] hover:text-white transition duration-300">Quizzes</a>
                    <a href="index.html#course-playlist" class="nav-link text-lg text-[#FFFFFF] hover:text-white transition duration-300">Course Playlist</a>
                    <a href="student-dashboard.html" class="nav-link text-lg text-[#FFFFFF] hover:text-white transition duration-300 active">Student Dashboard</a>
                    <!-- User Info and Logout (always present, visibility controlled by JS) -->
                    <div id="user-info" class="hidden flex items-center sm:space-x-2">
                        <span id="user-email-nav" class="text-white text-sm whitespace-nowrap overflow-hidden text-ellipsis max-w-[150px]"></span>
                        <button id="logout-btn" class="action-button">Logout</button>
                    </div>
                </div>
                <!-- Mobile Menu Button -->
                <button id="mobile-menu-button" class="sm:hidden text-[#FFFFFF] focus:outline-none">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                    </svg>
                </button>
            </div>
            <!-- Mobile Menu Overlay -->
            <div id="mobile-menu-overlay" class="hidden sm:hidden fixed inset-0 bg-[#0D0D0D] bg-opacity-100 z-9996 flex flex-col items-center justify-center space-y-8 text-2xl">
                <button id="close-mobile-menu" class="absolute top-6 right-6 text-[#FFFFFF] focus:outline-none">
                    <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
                <a href="index.html" class="nav-link text-[#FFFFFF] hover:text-white transition duration-300" onclick="document.getElementById('mobile-menu-overlay').classList.add('hidden'); document.body.classList.remove('overflow-hidden');">Home</a>
                <a href="index.html#quizzes" class="nav-link text-[#FFFFFF] hover:text-white transition duration-300" onclick="document.getElementById('mobile-menu-overlay').classList.add('hidden'); document.body.classList.remove('overflow-hidden');">Course Playlist</a>
                <a href="index.html#course-playlist" class="nav-link text-[#FFFFFF] hover:text-white transition duration-300" onclick="document.getElementById('mobile-menu-overlay').classList.add('hidden'); document.body.classList.remove('overflow-hidden');">Quizzes</a>
                <a href="student-dashboard.html" class="nav-link text-[#FFFFFF] hover:text-white transition duration-300 active" onclick="document.getElementById('mobile-menu-overlay').classList.add('hidden'); document.body.classList.remove('overflow-hidden');">Student Dashboard</a>
                <!-- Mobile User Info and Logout (always present, visibility controlled by JS) -->
                <div id="mobile-user-info" class="hidden flex-col items-center space-y-2 sm:hidden">
                    <span id="mobile-user-email-nav" class="text-white text-xl"></span>
                    <button id="mobile-logout-btn" class="action-button">Logout</button>
                </div>
            </div>
        </nav>

        <main id="dashboard-main-content" class="container mx-auto p-4 flex-grow pt-24 hidden"> <!-- Added pt-24 to offset fixed navbar, hidden by default -->
            <header class="text-center mb-12">
                <h1 class="text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-yellow-500 mb-4 glowing-header">
                    Student Dashboard
                </h1>
                <p class="text-xl text-gray-300">Welcome, <span id="current-user-name" class="font-bold">Student</span>!</p>
                <p id="current-user-email-display" class="text-sm text-gray-400 mt-2"></p>
                <p id="student-id-display" class="text-base text-gray-300 mt-2">Student ID: <span class="font-semibold">N/A</span></p>
                <p id="enrollment-date-display" class="text-base text-gray-300 mt-2">Enrolled On: <span class="font-semibold">N/A</span></p>
            </header>

            <!-- Student Dashboard Content -->
            <section id="student-dashboard-content" class="p-8 bg-gradient-to-br from-[#1A1A1A] to-[#0D0D0D] rounded-lg shadow-xl mb-8">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <!-- Dashboard Card 1: Courses Enrolled -->
                    <div class="bg-[#2A2A2A] p-6 rounded-lg shadow-md flex items-center justify-between dashboard-card">
                        <div>
                            <p class="text-sm font-semibold text-orange-300 uppercase">Courses Enrolled</p>
                            <p id="courses-enrolled-count" class="text-5xl font-bold text-white mt-2">0</p>
                        </div>
                        <i class="fa fa-book text-6xl text-[#FF8C00] opacity-50"></i>
                    </div>

                    <!-- Dashboard Card 2: Assignments Due -->
                    <div class="bg-[#2A2A2A] p-6 rounded-lg shadow-md flex items-center justify-between dashboard-card">
                        <div>
                            <p class="text-sm font-semibold text-orange-300 uppercase">Assignments Count</p>
                            <p id="assignments-count" class="text-5xl font-bold text-white mt-2">0</p>
                        </div>
                        <i class="fa fa-clipboard text-6xl text-[#FF8C00] opacity-50"></i>
                    </div>

                    <!-- Dashboard Card 3: Overall Progress -->
                    <div class="bg-[#2A2A2A] p-6 rounded-lg shadow-md flex items-center justify-between dashboard-card">
                        <div>
                            <p class="text-sm font-semibold text-orange-300 uppercase">Overall Progress</p>
                            <p id="overall-progress-percentage" class="text-5xl font-bold text-white mt-2">N/A</p>
                        </div>
                        <i class="fa fa-line-chart text-6xl text-[#FF8C00] opacity-50"></i>
                    </div>
                </div>

                <!-- Enrollment Details -->
                <div class="bg-[#2A2A2A] p-6 rounded-lg shadow-md mb-8 fade-in-section">
                    <h3 class="text-2xl font-semibold text-white mb-4"><i class="fa fa-info-circle text-[#FF8C00] mr-2"></i>Enrollment Information</h3>
                    <div class="mb-4">
                        <p class="text-gray-300 font-semibold mb-2">Enrollment Receipt:</p>
                        <a id="enrollment-receipt-link" href="#" target="_blank" class="text-[#60A5FA] hover:underline text-lg flex items-center">
                            <i class="fa fa-external-link mr-2 text-base"></i><span>No receipt URL provided.</span>
                        </a>
                    </div>
                </div>

                <!-- My Courses (Detailed List) -->
                <div class="bg-[#2A2A2A] p-6 rounded-lg shadow-md mb-8 fade-in-section">
                    <h3 class="text-2xl font-semibold text-white mb-4"><i class="fa fa-graduation-cap text-[#FF8C00] mr-2"></i>My Registered Courses</h3>
                    <ul id="my-courses-list" class="space-y-3">
                        <li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg shadow-inner list-item">No courses registered.</li>
                    </ul>
                </div>

                <!-- My Assignments -->
                <div class="bg-[#2A2A2A] p-6 rounded-lg shadow-md mb-8 fade-in-section">
                    <h3 class="text-2xl font-semibold text-white mb-4"><i class="fa fa-tasks text-[#60A5FA] mr-2"></i>My Assignments</h3>
                    <ul id="my-assignments-list" class="space-y-3">
                        <li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg shadow-inner list-item">No assignments provided.</li>
                    </ul>
                </div>

                <!-- My Certificates -->
                <div class="bg-[#2A2A2A] p-6 rounded-lg shadow-md mb-8 fade-in-section">
                    <h3 class="text-2xl font-semibold text-white mb-4"><i class="fa fa-certificate text-[#10B981] mr-2"></i>My Certificates</h3>
                    <ul id="my-certificates-list" class="space-y-3">
                        <li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg shadow-inner list-item">No certificates provided.</li>
                    </ul>
                </div>

                <!-- My Notes -->
                <div class="bg-[#2A2A2A] p-6 rounded-lg shadow-md mb-8 fade-in-section">
                    <h3 class="text-2xl font-semibold text-white mb-4"><i class="fa fa-pencil-square-o icon-notes mr-2"></i>My Notes</h3>
                    <div id="my-notes-content" class="text-gray-300 leading-relaxed mb-3">
                        <p class="text-gray-400 text-center">No notes provided.</p>
                    </div>
                    <p class="text-gray-300 font-semibold mb-2">Notes Attachments:</p>
                    <ul id="my-notes-attachments-list" class="space-y-2">
                        <li class="text-gray-400 text-center text-sm bg-[#1A1A1A] p-3 rounded-lg list-item">No attachments.</li>
                    </ul>
                </div>

                <!-- Recent Activity / Notifications -->
                <div class="bg-[#2A2A2A] p-6 rounded-lg shadow-md mb-8 fade-in-section">
                    <h3 class="text-2xl font-semibold text-white mb-4"><i class="fa fa-history text-[#00BCD4] mr-2"></i>Recent Activity</h3>
                    <ul id="recent-activity-list" class="space-y-4">
                        <li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg shadow-inner list-item">No recent activity.</li>
                    </ul>
                </div>

                <!-- Upcoming Deadlines -->
                <div class="bg-[#2A2A2A] p-6 rounded-lg shadow-md mb-8 fade-in-section">
                    <h3 class="text-2xl font-semibold text-white mb-4"><i class="fa fa-hourglass-half text-[#FFC107] mr-2"></i>Upcoming Deadlines</h3>
                    <ul id="upcoming-deadlines-list" class="space-y-3">
                        <li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg shadow-inner list-item">No upcoming deadlines.</li>
                    </ul>
                </div>

                <!-- NEW: Feedback Section - Renamed and Styled -->
                <div class="bg-[#2A2A2A] p-6 rounded-lg shadow-md mb-8 fade-in-section">
                    <h3 class="text-2xl font-semibold text-white mb-4 section-header-feedback">
                        <i class="fa fa-comments-o icon-feedback mr-2"></i>Feedback From Teacher
                    </h3>
                    <ul id="feedback-list" class="space-y-4"> <!-- Increased space -->
                        <li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No feedback yet.</li>
                    </ul>
                </div>

                <!-- NEW: Attendance History Section -->
                <div class="bg-[#2A2A2A] p-6 rounded-lg shadow-md mb-8 fade-in-section">
                    <h3 class="text-2xl font-semibold text-white mb-4 section-header-attendance">
                        <i class="fa fa-check-square-o icon-attendance mr-2"></i>Attendance History
                    </h3>
                    <ul id="attendance-list" class="space-y-3">
                        <li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No attendance records.</li>
                    </ul>
                </div>

                <!-- NEW: Recorded Sessions Section -->
                <div class="bg-[#2A2A2A] p-6 rounded-lg shadow-md mb-8 fade-in-section">
                    <h3 class="text-2xl font-semibold text-white mb-4 section-header-sessions">
                        <i class="fa fa-video-camera icon-sessions mr-2"></i>Recorded Sessions
                    </h3>
                    <ul id="recorded-sessions-list" class="space-y-3">
                        <li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No recorded sessions.</li>
                    </ul>
                </div>

            </section>
        </main>

        <footer class="mt-12 text-gray-500 text-sm text-center">
            &copy; 2025 Fortitude Frontier. All rights reserved.
        </footer>
    </div>

    <!-- Firebase SDKs -->
    <script type="module" defer>
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

        let app;
        let auth;
        let db;
        let currentUserId = null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Using __app_id for Firestore paths

        const firebaseConfig = {
            apiKey: "AIzaSyCqWbcgSdseuGSd6aLBqG76lAyr647xgQ4",
            authDomain: "signup-b09e6.firebaseapp.com",
            projectId: "signup-b09e6",
            storageBucket: "signup-b09e6.appspot.com", // Corrected storageBucket to appspot.com
            messagingSenderId: "203916695845",
            appId: "1:203916695845:web:5310b5ca37c7809be862cc"
        };

        // Initialize Firebase
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        // Variables to hold unsubscribe functions for Firestore listeners
        let unsubscribeProfile = null;
        let unsubscribeStudentRecord = null;

        // DOM elements for Student Login Modal
        const studentLoginModal = document.getElementById('student-login-modal');
        const studentLoginCloseButton = document.getElementById('student-login-close-button');
        const studentAuthForm = document.getElementById('student-auth-form');
        const studentEmailInput = document.getElementById('student-email');
        const studentPasswordInput = document.getElementById('student-password');
        const studentLoginBtn = document.getElementById('student-login-btn');
        const studentAuthMessage = document.getElementById('student-auth-message');

        // Main dashboard content
        const dashboardMainContent = document.getElementById('dashboard-main-content');

        // Dashboard content elements
        const currentUserNameDisplay = document.getElementById('current-user-name');
        const currentUserEmailDisplay = document.getElementById('current-user-email-display');
        const studentIdDisplay = document.getElementById('student-id-display').querySelector('span'); // Get the span inside
        const enrollmentDateDisplay = document.getElementById('enrollment-date-display').querySelector('span'); // Get the span inside
        const coursesEnrolledCount = document.getElementById('courses-enrolled-count');
        const assignmentsCount = document.getElementById('assignments-count');
        const overallProgressPercentage = document.getElementById('overall-progress-percentage');
        const recentActivityList = document.getElementById('recent-activity-list');
        const myCoursesList = document.getElementById('my-courses-list');
        const upcomingDeadlinesList = document.getElementById('upcoming-deadlines-list');
        const enrollmentReceiptLink = document.getElementById('enrollment-receipt-link');
        const myAssignmentsList = document.getElementById('my-assignments-list');
        const myCertificatesList = document.getElementById('my-certificates-list');
        const myNotesContent = document.getElementById('my-notes-content'); // Notes text
        const myNotesAttachmentsList = document.getElementById('my-notes-attachments-list'); // Notes URLs list

        // NEW: Dashboard sections for Feedback, Attendance, Recorded Sessions
        const feedbackList = document.getElementById('feedback-list');
        const attendanceList = document.getElementById('attendance-list');
        const recordedSessionsList = document.getElementById('recorded-sessions-list');

        // Navbar user info displays
        const userEmailNavDisplay = document.getElementById('user-email-nav');
        const mobileUserEmailNavDisplay = document.getElementById('mobile-user-email-nav');

        // Message Box function
        const showMessageBox = (message, onConfirm = null) => {
            const msgBox = document.getElementById('custom-message-box');
            const msgText = document.getElementById('message-box-text');
            const confirmBtn = document.getElementById('message-box-confirm-btn');

            msgText.innerHTML = message;
            confirmBtn.onclick = () => {
                msgBox.classList.remove('show');
                document.body.classList.remove('overflow-hidden');
                if (onConfirm) onConfirm();
            };
            msgBox.classList.add('show');
            document.body.classList.add('overflow-hidden');
        };

        // Function to show/hide modals
        const hideAllModals = () => {
            studentLoginModal.classList.remove('show');
            document.body.classList.remove('overflow-hidden');
        };

        const showStudentLoginModal = () => {
            hideAllModals();
            studentLoginModal.classList.add('show');
            document.body.classList.add('overflow-hidden');
            studentAuthMessage.classList.add('hidden'); // Clear previous messages
        };

        // Close modal listeners
        if (studentLoginCloseButton) {
            studentLoginCloseButton.addEventListener('click', () => hideAllModals());
        }
        if (studentLoginModal) {
            studentLoginModal.addEventListener('click', (e) => {
                if (e.target === studentLoginModal) {
                    hideAllModals();
                }
            });
        }

        /**
         * Loads and listens for real-time updates to the user's dashboard data from Firestore.
         * @param {string} userId The UID of the currently logged-in user.
         * @param {string} userEmail The email of the currently logged-in user.
         * @returns {object} An object containing unsubscribe functions for the listeners.
         */
        const loadDashboardData = (userId, userEmail) => {
            // Listener for profile data
            const userProfileRef = doc(db, "artifacts", appId, "users", userId, "profile", "details");
            const unsubProfile = onSnapshot(userProfileRef, (docSnap) => {
                if (docSnap.exists()) {
                    const profileData = docSnap.data();
                    currentUserNameDisplay.textContent = profileData.name || 'Student'; // Display name or fallback
                    currentUserEmailDisplay.textContent = userEmail; // Display email
                } else {
                    console.log("No profile data found for user. Displaying email and setting default.");
                    currentUserNameDisplay.textContent = 'Student'; // Default if no name
                    currentUserEmailDisplay.textContent = userEmail; // Display email
                    // Potentially create a default profile here if desired (e.g., from an admin-added student record)
                    setDoc(userProfileRef, {
                        name: 'Student', // Default name
                        email: userEmail,
                        createdAt: new Date()
                    }, { merge: true }).catch(e => console.error("Error setting default profile:", e));
                }
            }, (error) => {
                console.error("Error listening to user profile data:", error);
                // Only show message box if user is still actually authenticated for this UID
                if (auth.currentUser && auth.currentUser.uid === userId) {
                    showMessageBox(`Error loading profile data: ${error.message}.`);
                }
            });

            // Listener for student record data from admin panel
            // Query for the student document where the 'uid' matches the authenticated user's UID
            const studentRecordQuery = query(collection(db, "artifacts", appId, "student_record"), where("uid", "==", userId));
            const unsubStudentRecord = onSnapshot(studentRecordQuery, (querySnapshot) => {
                if (!querySnapshot.empty) {
                    const studentDoc = querySnapshot.docs[0]; // Assuming one student record per UID
                    const data = studentDoc.data();
                    console.log("Student record data fetched:", data);

                    // Update Student ID and Enrollment Date
                    studentIdDisplay.textContent = data.student_id || 'N/A';
                    if (data.date_of_enrollment) {
                        try {
                            const enrollmentDate = new Date(data.date_of_enrollment);
                            enrollmentDateDisplay.textContent = enrollmentDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                        } catch (e) {
                            console.error("Error parsing enrollment date:", e);
                            enrollmentDateDisplay.textContent = 'Invalid Date';
                        }
                    } else {
                        enrollmentDateDisplay.textContent = 'N/A';
                    }

                    // Update Courses Enrolled Count
                    const enrolledCourses = Array.isArray(data.course_enrollment) ? data.course_enrollment : [];
                    coursesEnrolledCount.textContent = enrolledCourses.length;

                    // Populate My Registered Courses List
                    myCoursesList.innerHTML = '';
                    if (enrolledCourses.length > 0) {
                        enrolledCourses.forEach(course => {
                            const li = document.createElement('li');
                            li.className = "bg-[#1A1A1A] p-4 rounded-lg shadow-inner flex items-center list-item";
                            li.innerHTML = `<i class="fa fa-book text-[#FF8C00] mr-3 text-xl"></i><span class="text-white text-lg">${course}</span>`;
                            myCoursesList.appendChild(li);
                        });
                    } else {
                        myCoursesList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No courses registered.</li>';
                    }

                    // Display Enrollment Receipt URL
                    const enrollmentReceiptSection = enrollmentReceiptLink.closest('div'); // Get parent div for visibility
                    if (data.enrollment_receipt_url && data.enrollment_receipt_url.trim() !== '') {
                        enrollmentReceiptLink.href = data.enrollment_receipt_url;
                        enrollmentReceiptLink.querySelector('span').textContent = "View Enrollment Receipt";
                        enrollmentReceiptLink.classList.remove('hidden');
                        enrollmentReceiptSection.classList.remove('hidden'); // Ensure section is visible
                    } else {
                        enrollmentReceiptLink.querySelector('span').textContent = "No receipt URL provided.";
                        enrollmentReceiptLink.removeAttribute('href');
                        enrollmentReceiptLink.classList.add('hidden');
                        // Optionally hide the entire section if no receipt
                        // enrollmentReceiptSection.classList.add('hidden');
                    }

                    // Populate My Assignments List
                    const assignments = Array.isArray(data.assignments) ? data.assignments : [];
                    assignmentsCount.textContent = assignments.length; // Update assignment count
                    myAssignmentsList.innerHTML = '';
                    if (assignments.length > 0) {
                        assignments.forEach((url, index) => {
                            const li = document.createElement('li');
                            li.className = "bg-[#1A1A1A] p-4 rounded-lg shadow-inner flex items-center list-item";
                            li.innerHTML = `<i class="fa fa-file-text-o text-[#60A5FA] mr-3 text-xl"></i><a href="${url}" target="_blank" class="text-white hover:underline transition-colors duration-200 truncate flex-grow">Assignment ${index + 1}</a>`;
                            myAssignmentsList.appendChild(li);
                        });
                    } else {
                        myAssignmentsList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No assignments provided.</li>';
                    }

                    // Populate My Certificates List
                    const certificates = Array.isArray(data.certificates) ? data.certificates : [];
                    myCertificatesList.innerHTML = '';
                    if (certificates.length > 0) {
                        certificates.forEach((url, index) => {
                            const li = document.createElement('li');
                            li.className = "bg-[#1A1A1A] p-4 rounded-lg shadow-inner flex items-center list-item";
                            li.innerHTML = `<i class="fa fa-certificate text-[#10B981] mr-3 text-xl"></i><a href="${url}" target="_blank" class="text-white hover:underline transition-colors duration-200 truncate flex-grow">Certificate ${index + 1}</a>`;
                            myCertificatesList.appendChild(li);
                        });
                    } else {
                        myCertificatesList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No certificates provided.</li>';
                    }

                    // Populate Overall Progress
                    overallProgressPercentage.textContent = data.overall_progress !== null ? `${data.overall_progress}%` : 'N/A';

                    // Populate My Notes Content
                    const notes = data.notes || '';
                    myNotesContent.innerHTML = '';
                    if (notes.trim() !== '') {
                        myNotesContent.innerHTML = `<p>${notes}</p>`;
                    } else {
                        myNotesContent.innerHTML = '<p class="text-gray-400 text-center">No notes provided by admin.</p>';
                    }

                    // Populate My Notes Attachments
                    const notesAttachments = Array.isArray(data.notes_attachments) ? data.notes_attachments : [];
                    myNotesAttachmentsList.innerHTML = '';
                    if (notesAttachments.length > 0) {
                        notesAttachments.forEach((url, index) => {
                            const li = document.createElement('li');
                            li.className = "flex items-center text-sm text-gray-300 bg-[#1A1A1A] p-3 rounded-lg list-item"; /* Added bg and padding */
                            li.innerHTML = `<i class="fa fa-link text-[#60A5FA] mr-2"></i><a href="${url}" target="_blank" class="hover:underline truncate">${url}</a>`;
                            myNotesAttachmentsList.appendChild(li);
                        });
                    } else {
                        myNotesAttachmentsList.innerHTML = '<li class="text-gray-400 text-center text-sm bg-[#1A1A1A] p-3 rounded-lg list-item">No attachments.</li>';
                    }

                    // Populate Upcoming Deadlines
                    const upcomingDeadlines = Array.isArray(data.upcoming_deadlines) ? data.upcoming_deadlines : [];
                    upcomingDeadlinesList.innerHTML = '';
                    if (upcomingDeadlines.length > 0) {
                        upcomingDeadlines.forEach(item => {
                            const li = document.createElement('li');
                            li.className = "bg-[#1A1A1A] p-4 rounded-lg shadow-inner flex items-center list-item";
                            li.innerHTML = `<i class="fa fa-calendar text-[#FFC107] mr-3 text-xl"></i><span class="text-white">${item}</span>`;
                            upcomingDeadlinesList.appendChild(li);
                        });
                    } else {
                        upcomingDeadlinesList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No upcoming deadlines.</li>';
                    }

                    // Populate Recent Activity
                    const recentActivity = Array.isArray(data.recent_activity) ? data.recent_activity : [];
                    recentActivityList.innerHTML = '';
                    if (recentActivity.length > 0) {
                        recentActivity.forEach(item => {
                            const li = document.createElement('li');
                            li.className = "bg-[#1A1A1A] p-4 rounded-lg shadow-inner flex items-center list-item";
                            li.innerHTML = `<i class="fa fa-history text-[#00BCD4] mr-3 text-xl"></i><span class="text-white">${item}</span>`;
                            recentActivityList.appendChild(li);
                        });
                    } else {
                        recentActivityList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No recent activity.</li>';
                    }

                    // NEW: Populate Feedback - Styled with feedback-item-card
                    const feedback = Array.isArray(data.feedback) ? data.feedback : [];
                    feedbackList.innerHTML = '';
                    if (feedback.length > 0) {
                        // Sort feedback by timestamp descending (newest first)
                        feedback.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        feedback.forEach(item => {
                            const li = document.createElement('li');
                            li.className = "feedback-item-card"; // Apply new styling class
                            const feedbackDate = new Date(item.timestamp).toLocaleString();
                            li.innerHTML = `
                                <p class="feedback-text">${item.text}</p>
                                <p class="feedback-timestamp">Sent: ${feedbackDate}</p>
                            `;
                            feedbackList.appendChild(li);
                        });
                    } else {
                        feedbackList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No feedback yet.</li>';
                    }

                    // NEW: Populate Attendance History
                    const attendance = Array.isArray(data.attendance) ? data.attendance : [];
                    attendanceList.innerHTML = '';
                    if (attendance.length > 0) {
                        // Sort attendance by date descending (most recent first)
                        attendance.sort((a, b) => new Date(b.date) - new Date(a.date));
                        attendance.forEach(item => {
                            const li = document.createElement('li');
                            li.className = "bg-[#1A1A1A] p-4 rounded-lg shadow-inner flex items-center list-item";
                            const attendanceDate = new Date(item.date).toLocaleDateString();
                            const statusColor = item.status === 'Present' ? 'status-present' : item.status === 'Absent' ? 'status-absent' : 'status-late';
                            li.innerHTML = `
                                <i class="fa fa-calendar-check-o icon-attendance mr-3 text-xl"></i>
                                <span class="text-white">Date: ${attendanceDate}</span>
                                <span class="ml-auto ${statusColor} font-semibold">${item.status}</span>
                            `;
                            attendanceList.appendChild(li);
                        });
                    } else {
                        attendanceList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No attendance records.</li>';
                    }

                    // NEW: Populate Recorded Sessions
                    const recordedSessions = Array.isArray(data.recorded_sessions) ? data.recorded_sessions : [];
                    recordedSessionsList.innerHTML = '';
                    if (recordedSessions.length > 0) {
                         // Sort sessions by date descending (most recent first)
                        recordedSessions.sort((a, b) => new Date(b.date) - new Date(a.date));
                        recordedSessions.forEach((sessionObj, index) => {
                            const li = document.createElement('li');
                            li.className = "bg-[#1A1A1A] p-4 rounded-lg shadow-inner flex flex-col sm:flex-row sm:items-center list-item";
                            const displayDate = new Date(sessionObj.date).toLocaleDateString();
                            li.innerHTML = `
                                <i class="fa fa-play-circle-o icon-sessions mr-3 text-xl"></i>
                                <span class="text-white mr-2">Session on ${displayDate}:</span>
                                <a href="${sessionObj.url}" target="_blank" class="text-[#EAB308] hover:underline transition-colors duration-200 truncate flex-grow mt-2 sm:mt-0">${sessionObj.url}</a>
                            `;
                            recordedSessionsList.appendChild(li);
                        });
                    } else {
                        recordedSessionsList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No recorded sessions.</li>';
                    }


                } else {
                    console.log("No student record found for this user in 'student_record' collection. Resetting dashboard.");
                    // Reset dashboard if no record is found
                    studentIdDisplay.textContent = 'N/A';
                    enrollmentDateDisplay.textContent = 'N/A';
                    coursesEnrolledCount.textContent = '0';
                    assignmentsCount.textContent = '0';
                    overallProgressPercentage.textContent = 'N/A';
                    enrollmentReceiptLink.textContent = "No receipt URL provided.";
                    enrollmentReceiptLink.removeAttribute('href');
                    enrollmentReceiptLink.classList.add('hidden');
                    myCoursesList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No courses registered.</li>';
                    myAssignmentsList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No assignments provided.</li>';
                    myCertificatesList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No certificates provided.</li>';
                    myNotesContent.innerHTML = '<p class="text-gray-400 text-center">No notes provided by admin.</p>';
                    myNotesAttachmentsList.innerHTML = '<li class="text-gray-400 text-center text-sm list-item">No attachments.</li>';
                    recentActivityList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No recent activity.</li>';
                    upcomingDeadlinesList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No upcoming deadlines.</li>';
                    feedbackList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No feedback yet.</li>'; // Reset feedback
                    attendanceList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No attendance records.</li>'; // Reset attendance
                    recordedSessionsList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No recorded sessions.</li>'; // Reset recorded sessions
                }
            }, (error) => {
                console.error("Error listening to student record data:", error);
                // Only show message box if user is still actually authenticated for this UID
                if (auth.currentUser && auth.currentUser.uid === userId) {
                    showMessageBox(`Error loading student data: ${error.message}.`);
                }
            });
            return { unsubscribeProfile: unsubProfile, unsubscribeStudentRecord: unsubStudentRecord };
        };


        // Student Login Form Submission
        if (studentAuthForm) {
            studentAuthForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = studentEmailInput.value;
                const password = studentPasswordInput.value;
                studentAuthMessage.classList.add('hidden');

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    showMessageBox("Logged in successfully as student!");
                    hideAllModals();
                    // onAuthStateChanged will handle showing the dashboard and loading data
                } catch (error) {
                    console.error("Student Login error:", error.code, error.message);
                    let errorMessage = `Login failed: ${error.message}.`;
                    if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        errorMessage = "Invalid email or password. Please check your student credentials.";
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = "Invalid email format for student login.";
                    } else if (error.code === 'auth/too-many-requests') {
                        errorMessage = "Too many failed login attempts. Please try again later.";
                    } else {
                        errorMessage = `An unexpected error occurred during student login: ${error.message}.`;
                    }
                    studentAuthMessage.textContent = errorMessage;
                    studentAuthMessage.classList.remove('hidden');
                }
            });
        }

        // OnAuthStateChanged listener to handle user state and show/hide dashboard
        onAuthStateChanged(auth, (user) => {
            const logoutBtn = document.getElementById('logout-btn');
            const mobileLogoutBtn = document.getElementById('mobile-logout-btn');
            const userInfoDisplay = document.getElementById('user-info');
            const mobileUserInfoDisplay = document.getElementById('mobile-user-info');

            if (user) {
                currentUserId = user.uid;
                // Update navbar email display
                if (userEmailNavDisplay) userEmailNavDisplay.textContent = user.email || '';
                if (mobileUserEmailNavDisplay) mobileUserEmailNavDisplay.textContent = user.email || '';

                if (userInfoDisplay) userInfoDisplay.classList.remove('hidden');
                if (mobileUserInfoDisplay) mobileUserInfoDisplay.classList.remove('hidden');

                dashboardMainContent.classList.remove('hidden'); // Show dashboard content if logged in
                // Call loadDashboardData and store unsubscribe functions
                const unsubs = loadDashboardData(currentUserId, user.email || 'N/A');
                unsubscribeProfile = unsubs.unsubscribeProfile;
                unsubscribeStudentRecord = unsubs.unsubscribeStudentRecord;
                hideAllModals(); // Hide any open login/signup modals
            } else {
                currentUserId = null;
                // Clear navbar email display
                if (userEmailNavDisplay) userEmailNavDisplay.textContent = '';
                if (mobileUserEmailNavDisplay) mobileUserEmailNavDisplay.textContent = '';

                if (userInfoDisplay) userInfoDisplay.classList.add('hidden');
                if (mobileUserInfoDisplay) mobileUserInfoDisplay.classList.add('hidden');

                dashboardMainContent.classList.add('hidden'); // Hide dashboard content if logged out
                showStudentLoginModal(); // Show student login modal if not logged in

                // Unsubscribe from Firestore listeners on logout
                if (unsubscribeProfile) {
                    unsubscribeProfile();
                    unsubscribeProfile = null;
                }
                if (unsubscribeStudentRecord) {
                    unsubscribeStudentRecord();
                    unsubscribeStudentRecord = null;
                }
            }
        });

        // Intersection Observer for fade-in sections
        const observerOptions = {
            root: null, /* viewport */
            rootMargin: '0px',
            threshold: 0.1 /* element is 10% visible */
        };

        const observer = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('is-visible');
                    observer.unobserve(entry.target); // Stop observing once visible
                }
            });
        }, observerOptions);

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.fade-in-section').forEach(section => {
                observer.observe(section);
            });

            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const closeMobileMenuButton = document.getElementById('close-mobile-menu');
            const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');

            if (mobileMenuButton) {
                mobileMenuButton.addEventListener('click', () => {
                    mobileMenuOverlay.classList.remove('hidden');
                    document.body.classList.add('overflow-hidden');
                });
            }

            if (closeMobileMenuButton) {
                closeMobileMenuButton.addEventListener('click', () => {
                    mobileMenuOverlay.classList.add('hidden');
                    document.body.classList.remove('overflow-hidden');
                });
            }

            // Logout logic for this page
            const logoutBtn = document.getElementById('logout-btn');
            const mobileLogoutBtn = document.getElementById('mobile-logout-btn');

            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    try {
                        await signOut(auth);
                        showMessageBox("Logged out successfully! Redirecting to homepage.", () => {
                            window.location.href = 'index.html'; // Redirect to home after logout
                        });
                    } catch (error) {
                        console.error('Logout error:', error);
                        showMessageBox(`Logout failed: ${error.message}`);
                    }
                });
            }

            if (mobileLogoutBtn) {
                mobileLogoutBtn.addEventListener('click', async () => {
                    try {
                        await signOut(auth);
                        showMessageBox("Logged out successfully! Redirecting to homepage.", () => {
                            mobileMenuOverlay.classList.add('hidden');
                            document.body.classList.remove('overflow-hidden');
                            window.location.href = 'index.html'; // Redirect to home after logout
                        });
                    } catch (error) {
                        console.error('Mobile logout error:', error);
                        showMessageBox(`Mobile logout failed: ${error.message}`);
                    }
                });
            }
        });
    </script>
</body>
</html>
