<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - Fortitude Frontier</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
        /* Custom CSS for Fortitude Frontier - Orange & Black Theme */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0D0D0D; /* Background: Very dark grey/black */
            color: #FFFFFF; /* On-Background/On-Surface: White text */
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Custom styles for consistent look with main page */
        .action-button {
            background-color: #FF8C00; /* Vibrant Orange */
            color: #0D0D0D; /* On-Primary: Dark text */
            transition: background-color 0.3s ease, transform 0.2s ease;
            border-radius: 9999px; /* Fully rounded for sleek look */
            padding: 0.75rem 1.5rem; /* More generous padding */
            font-weight: 700; /* Extra bold */
        }

        .action-button:hover {
            background-color: #FF7F00; /* Darker Orange on hover */
            transform: translateY(-2px) scale(1.02); /* Slight lift and scale */
            color: #FFFFFF; /* On-Secondary: White text */
        }

        /* Scrollbar styles */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #f97316; /* Orange-500 */
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #ea580c; /* Orange-600 */
        }
        #logoimg{
           height: 10vh;
           padding: 0;
           filter: drop-shadow(0 0 5px rgba(255,140,0,0.5)); /* Subtle logo glow */
        }

        /* Modal styling */
        .modal {
            position: fixed;
            z-index: 9997;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.85); /* Slightly darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.4s ease, visibility 0.4s ease; /* Slower, smoother transition */
        }
        .modal.show {
            visibility: visible;
            opacity: 1;
        }
        .modal-content {
            background-color: #1A1A1A;
            margin: auto;
            padding: 2.5rem;
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 8px 25px rgba(0,0,0,0.6); /* Stronger, deeper shadow */
            width: 90%;
            max-width: 550px; /* Slightly wider modal */
            position: relative;
            transform: translateY(-30px) scale(0.95); /* More pronounced entry animation */
            transition: transform 0.4s ease, opacity 0.4s ease;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid #333; /* Subtle border */
        }
        .modal.show .modal-content {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
        .close-button {
            color: #FFFFFF;
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            font-size: 2.2rem; /* Larger close button */
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .close-button:hover,
        .close-button:focus {
            color: #FF8C00;
            transform: rotate(90deg); /* Rotate on hover */
        }
        /* Message box styling */
        .message-box {
            background-color: #2A2A2A;
            color: #FFFFFF;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            text-align: center;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9998;
            min-width: 300px;
            max-width: 90%;
            display: none; /* Hidden by default */
            animation: fadeIn 0.3s ease-out; /* Add fade in animation */
        }
        .message-box.show {
            display: block;
        }
        .message-box button {
            margin-top: 1rem;
            background-color: #FF8C00;
            color: #0D0D0D;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .message-box button:hover {
            background-color: #FF7F00;
            transform: scale(1.05);
        }

        /* Card Hover Animations */
        .dashboard-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
            border: 1px solid rgba(255, 140, 0, 0.1); /* Subtle border */
        }
        .dashboard-card:hover {
            transform: translateY(-8px) scale(1.03); /* More pronounced lift and scale */
            box-shadow: 0 12px 25px rgba(255, 140, 0, 0.3); /* Stronger orange glow */
            background-color: #3A3A3A; /* Slightly lighter on hover */
        }

        .list-item {
            transition: background-color 0.2s ease, transform 0.1s ease;
            border-radius: 0.75rem; /* More rounded list items */
            overflow: hidden; /* Ensure content fits */
        }
        .list-item:hover {
            background-color: #3a3a3a !important; /* Slightly lighter dark gray on hover */
            transform: translateX(5px); /* Slide effect on hover */
        }

        /* Specific section colors for icons/headers */
        .section-header-feedback { color: #60A5FA; /* Blue */ }
        .section-header-attendance { color: #10B981; /* Green */ }
        .section-header-sessions { color: #EAB308; /* Yellow */ }
        .section-header-student-feedback { color: #FACC15; /* Amber */ } /* NEW */
        .section-header-timings { color: #8B5CF6; /* Purple for timings */ } /* NEW */
        .section-header-assignments { color: #60A5FA; } /* Blue for Assignments */


        .icon-feedback { color: #60A5FA; }
        .icon-attendance { color: #10B981; }
        .icon-sessions { color: #EAB308; }
        .icon-notes { color: #9B59B6; /* Purple */ } /* Added specific notes icon color */
        .icon-student-feedback { color: #FACC15; } /* NEW */
        .icon-timings { color: #8B5CF6; } /* NEW */
        .icon-assignments { color: #60A5FA; } /* Blue for Assignments */


        /* NEW: Feedback item styling for cool look */
        .feedback-item-card {
            background-color: #3a3a3a; /* Slightly lighter background for the card */
            border-left: 6px solid #60A5FA; /* Thicker accent border on the left */
            padding: 1.2rem 1.8rem; /* More padding */
            border-radius: 0.75rem; /* Consistent border-radius */
            box-shadow: 0 4px 12px rgba(0,0,0,0.25); /* Enhanced shadow */
            position: relative;
            overflow: hidden;
            animation: fadeIn 0.6s ease-out forwards; /* Slower fade in animation */
            margin-bottom: 0.75rem; /* Space between cards */
        }
        .feedback-item-card:last-child {
            margin-bottom: 0; /* No margin for the last one */
        }
        .feedback-item-card:before {
            content: "\f075"; /* Font Awesome comment icon */
            font-family: 'FontAwesome';
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 3.5em; /* Larger icon */
            color: rgba(96, 165, 250, 0.15); /* Slightly more faded blue */
            z-index: 0;
            pointer-events: none;
            transform: rotate(-10deg); /* Slight rotation for dynamic feel */
        }
        .feedback-item-card p {
            position: relative; /* Ensure text is above pseudo-element */
            z-index: 1;
        }
        .feedback-item-card .feedback-text {
            color: #E2E8F0; /* Lighter text for contrast */
            font-size: 1.15rem; /* Slightly larger text */
            margin-bottom: 0.6rem; /* More space */
            line-height: 1.5; /* Better line spacing */
        }
        .feedback-item-card .feedback-timestamp {
            color: #B0B9C4; /* A bit lighter gray for timestamp */
            font-size: 0.9rem; /* Slightly larger timestamp */
            font-style: italic;
        }

        /* NEW: Student Feedback Send Section styling */
        .student-feedback-send-card {
            background-color: #2A2A2A;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border: 1px solid rgba(250, 204, 21, 0.3); /* Yellowish border */
        }

        /* NEW: Reply styling within student feedback */
        .admin-reply-card {
            background-color: #4A4A4A; /* Darker background for replies */
            border-left: 4px solid #60A5FA; /* Blue border for admin replies */
            padding: 0.8rem 1.2rem;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            margin-left: 1.5rem; /* Indent replies */
            font-size: 0.95rem;
            line-height: 1.4;
        }
        .admin-reply-card .reply-timestamp {
            font-size: 0.8rem;
            color: #B0B9C4;
            margin-top: 0.2rem;
        }

        /* NEW: Assignment Item Styling */
        .assignment-item-card {
            background-color: #3a3a3a;
            border-left: 6px solid #60A5FA; /* Blue accent for assignments */
            padding: 1.2rem 1.8rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            margin-bottom: 0.75rem;
            animation: fadeIn 0.6s ease-out forwards;
        }
        .assignment-item-card .assignment-title {
            font-weight: 600;
            color: #E2E8F0;
            font-size: 1.15rem;
            margin-bottom: 0.4rem;
        }
        .assignment-item-card .assignment-details {
            color: #B0B9C4;
            font-size: 0.95rem;
            line-height: 1.4;
        }
        .assignment-item-card .assignment-url {
            color: #60A5FA;
            text-decoration: underline;
            font-size: 0.95rem;
            word-break: break-all; /* Ensure long URLs wrap */
        }
        .assignment-item-card .status-indicator {
            font-weight: 700;
            padding: 0.3em 0.6em;
            border-radius: 0.5em;
            display: inline-block;
            margin-left: 0.5rem;
            font-size: 0.85rem;
        }
        .assignment-item-card .status-pending { background-color: #FBBF24; color: #333; } /* Amber */
        .assignment-item-card .status-submitted { background-color: #60A5FA; color: #FFF; } /* Blue */
        .assignment-item-card .status-graded { background-color: #10B981; color: #FFF; } /* Green */


        /* Animation for sections appearing */
        .fade-in-section {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }
        .fade-in-section.is-visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Specific styling for attendance status */
        .status-present { color: #34D399; /* Emerald Green */ }
        .status-absent { color: #EF4444; /* Red */ }
        .status-late { color: #FBBF24; /* Amber Yellow */ }


        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); } /* More movement on fade-in */
            to { opacity: 1; transform: translateY(0); }
        }
         @keyframes headerGlow {
            0% { text-shadow: 0 0 5px rgba(255, 140, 0, 0.5); }
            50% { text-shadow: 0 0 15px rgba(255, 140, 0, 0.8); }
            100% { text-shadow: 0 0 5px rgba(255, 140, 0, 0.5); }
        }
        .glowing-header {
            animation: headerGlow 3s infinite alternate; /* Apply glowing effect */
        }

        /* Styles for clickable headers */
        .collapsible-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0; /* Add some padding */
            transition: background-color 0.2s ease;
        }
        .collapsible-header:hover {
            background-color: #333; /* Slightly highlight on hover */
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
        }
        .collapsible-header .toggle-icon {
            transition: transform 0.3s ease;
        }
        .collapsible-header.collapsed .toggle-icon {
            transform: rotate(-90deg); /* Rotate icon when collapsed */
        }

        /* Style for class timing list items */
        .class-timing-item {
            background-color: #1A1A1A;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            border-left: 5px solid #8B5CF6; /* Purple accent */
        }
        .class-timing-item p {
            margin-bottom: 0.25rem;
        }
        .class-timing-item .class-name {
            font-weight: 600;
            color: #FFFFFF;
            font-size: 1.1rem;
        }
        .class-timing-item .class-details {
            color: #D1D5DB; /* Light gray */
            font-size: 0.9rem;
        }

        /* Calendar Styles */
        .calendar-container {
            background-color: #1A1A1A;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            margin-top: 1rem;
            border: 1px solid rgba(16, 185, 129, 0.3); /* Greenish border */
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            color: #FFFFFF;
        }

        .calendar-header button {
            background-color: #10B981; /* Green */
            color: #0D0D0D;
            padding: 0.5rem 0.8rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease;
        }
        .calendar-header button:hover {
            background-color: #059669; /* Darker Green */
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            text-align: center;
        }

        .calendar-day-header {
            font-weight: 700;
            color: #10B981; /* Green */
            padding: 0.5rem 0;
            border-bottom: 2px solid rgba(16, 185, 129, 0.5);
        }

        .calendar-day {
            background-color: #2A2A2A;
            padding: 0.75rem 0.25rem; /* Adjusted padding */
            border-radius: 0.5rem;
            position: relative;
            cursor: default;
            min-height: 48px; /* Ensure consistent height */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 0.9rem; /* Smaller font for number */
        }

        .calendar-day.empty {
            background-color: #1A1A1A;
            color: #4A4A4A;
        }

        .calendar-day.today {
            border: 2px solid #FF8C00; /* Orange border for today */
            font-weight: bold;
        }

        .calendar-day .day-number {
            font-weight: bold;
            font-size: 1.1em; /* Make day number slightly larger */
            margin-bottom: 0.2em;
        }

        .calendar-day .attendance-status {
            font-size: 0.7rem; /* Smaller text for status */
            font-weight: 600;
            padding: 0.1em 0.4em;
            border-radius: 0.3em;
            text-transform: uppercase;
            margin-top: 0.2em; /* Space between number and status */
        }

        .calendar-day.present {
            background-color: #1C332D; /* Darker green */
            border: 1px solid #34D399; /* Emerald Green */
        }
        .calendar-day.present .attendance-status {
            color: #34D399;
        }

        .calendar-day.absent {
            background-color: #331A1A; /* Darker red */
            border: 1px solid #EF4444; /* Red */
        }
        .calendar-day.absent .attendance-status {
            color: #EF4444;
        }

        .calendar-day.late {
            background-color: #332B1A; /* Darker amber */
            border: 1px solid #FBBF24; /* Amber Yellow */
        }
        .calendar-day.late .attendance-status {
            color: #FBBF24;
        }
    </style>
</head>
<body class="bg-[#0D0D0D] text-white">

    <!-- Message Box for Alerts/Confirmations -->
    <div id="custom-message-box" class="message-box">
        <p id="message-box-text" class="text-lg mb-4"></p>
        <button id="message-box-confirm-btn">OK</button>
    </div>

    <!-- Student Login Modal -->
    <div id="student-login-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="student-login-close-button">&times;</span>
            <h3 class="text-3xl font-bold text-[#FF8C00] mb-6 text-center">Student Login</h3>
            <form id="student-auth-form" class="space-y-4">
                <div>
                    <label for="student-email" class="block text-lg font-medium text-orange-300 mb-2">Email:</label>
                    <input type="email" id="student-email" class="w-full p-3 rounded-md bg-[#0D0D0D] text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#FF8C00]" placeholder="your.email@example.com" required>
                </div>
                <div>
                    <label for="student-password" class="block text-lg font-medium text-orange-300 mb-2">Password:</label>
                    <input type="password" id="student-password" class="w-full p-3 rounded-md bg-[#0D0D0D] text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#FF8C00]" placeholder="********" required>
                </div>
                <button type="submit" id="student-login-btn" class="w-full action-button font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">Login as Student</button>
                <p id="student-auth-message" class="text-center text-sm mt-4 text-red-400 hidden"></p>
            </form>
        </div>
    </div>

    <div class="min-h-screen flex flex-col py-10 px-4">
        <!-- Navbar for Student Dashboard Page -->
        <nav class="p-6 md:bg-[#1A1A1A] shadow-lg fixed top-0 w-full z-50">
            <div class="container flex justify-between items-center">
                <a href="index.html" class="md:text-xl"><img src="fflogo-removebg-preview.png" id="logoimg" alt="Fortitude Frontier Logo"></a>
                <div class="hidden sm:flex flex-wrap justify-end items-center sm:gap-x-4 sm:gap-y-2">
                    <a href="index.html" class="nav-link text-lg text-[#FFFFFF] hover:text-white transition duration-300">Home</a>
                    <a href="index.html#quizzes" class="nav-link text-lg text-[#FFFFFF] hover:text-white transition duration-300">Quizzes</a>
                    <a href="index.html#course-playlist" class="nav-link text-lg text-[#FFFFFF] hover:text-white transition duration-300">Course Playlist</a>
                    <a href="student-dashboard.html" class="nav-link text-lg text-[#FFFFFF] hover:text-white transition duration-300 active">Student Dashboard</a>
                    <!-- User Info and Logout (always present, visibility controlled by JS) -->
                    <div id="user-info" class="hidden flex items-center sm:space-x-2">
                        <span id="user-email-nav" class="text-white text-sm whitespace-nowrap overflow-hidden text-ellipsis max-w-[150px]"></span>
                        <button id="logout-btn" class="action-button">Logout</button>
                    </div>
                </div>
                <!-- Mobile Menu Button -->
                <button id="mobile-menu-button" class="sm:hidden text-[#FFFFFF] focus:outline-none">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                    </svg>
                </button>
            </div>
            <!-- Mobile Menu Overlay -->
            <div id="mobile-menu-overlay" class="hidden sm:hidden fixed inset-0 bg-[#0D0D0D] bg-opacity-100 z-9996 flex flex-col items-center justify-center space-y-8 text-2xl">
                <button id="close-mobile-menu" class="absolute top-6 right-6 text-[#FFFFFF] focus:outline-none">
                    <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
                <a href="index.html" class="nav-link text-[#FFFFFF] hover:text-white transition duration-300" onclick="document.getElementById('mobile-menu-overlay').classList.add('hidden'); document.body.classList.remove('overflow-hidden');">Home</a>
                <a href="index.html#quizzes" class="nav-link text-[#FFFFFF] hover:text-white transition duration-300" onclick="document.getElementById('mobile-menu-overlay').classList.add('hidden'); document.body.classList.remove('overflow-hidden');">Course Playlist</a>
                <a href="index.html#course-playlist" class="nav-link text-[#FFFFFF] hover:text-white transition duration-300" onclick="document.getElementById('mobile-menu-overlay').classList.add('hidden'); document.body.classList.remove('overflow-hidden');">Quizzes</a>
                <a href="student-dashboard.html" class="nav-link text-[#FFFFFF] hover:text-white transition duration-300 active" onclick="document.getElementById('mobile-menu-overlay').classList.add('hidden'); document.body.classList.remove('overflow-hidden');">Student Dashboard</a>
                <!-- Mobile User Info and Logout (always present, visibility controlled by JS) -->
                <div id="mobile-user-info" class="hidden flex-col items-center space-y-2 sm:hidden">
                    <span id="mobile-user-email-nav" class="text-white text-xl"></span>
                    <button id="mobile-logout-btn" class="action-button">Logout</button>
                </div>
            </div>
        </nav>

        <main id="dashboard-main-content" class="container mx-auto p-4 flex-grow pt-24 hidden"> <!-- Added pt-24 to offset fixed navbar, hidden by default -->
            <header class="text-center mb-12">
                <h1 class="text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-yellow-500 mb-4 glowing-header">
                    Student Dashboard
                </h1>
                <p class="text-xl text-gray-300">Welcome, <span id="current-user-name" class="font-bold">Student</span>!</p>
                <p id="current-user-email-display" class="text-sm text-gray-400 mt-2"></p>
                <p id="student-id-display" class="text-base text-gray-300 mt-2">Student ID: <span class="font-semibold">N/A</span></p>
                <p id="enrollment-date-display" class="text-base text-gray-300 mt-2">Enrolled On: <span class="font-semibold">N/A</span></p>
                <p id="student-record-last-updated" class="text-sm text-gray-500 mt-2">Data Last Updated: N/A</p> <!-- NEW -->
            </header>

            <!-- Student Dashboard Content -->
            <section id="student-dashboard-content" class="p-8 bg-gradient-to-br from-[#1A1A1A] to-[#0D0D0D] rounded-lg shadow-xl mb-8">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <!-- Dashboard Card 1: Courses Enrolled -->
                    <div class="bg-[#2A2A2A] p-6 rounded-lg shadow-md flex items-center justify-between dashboard-card">
                        <div>
                            <p class="text-sm font-semibold text-orange-300 uppercase">Courses Enrolled</p>
                            <p id="courses-enrolled-count" class="text-5xl font-bold text-white mt-2">0</p>
                        </div>
                        <i class="fa fa-book text-6xl text-[#FF8C00] opacity-50"></i>
                    </div>

                    <!-- Dashboard Card 2: Assignments Due -->
                    <div class="bg-[#2A2A2A] p-6 rounded-lg shadow-md flex items-center justify-between dashboard-card">
                        <div>
                            <p class="text-sm font-semibold text-orange-300 uppercase">Assignments Count</p>
                            <p id="assignments-count" class="text-5xl font-bold text-white mt-2">0</p>
                        </div>
                        <i class="fa fa-clipboard text-6xl text-[#FF8C00] opacity-50"></i>
                    </div>

                    <!-- Dashboard Card 3: Overall Progress -->
                    <div class="bg-[#2A2A2A] p-6 rounded-lg shadow-md flex items-center justify-between dashboard-card">
                        <div>
                            <p class="text-sm font-semibold text-orange-300 uppercase">Overall Progress</p>
                            <p id="overall-progress-percentage" class="text-5xl font-bold text-white mt-2">N/A</p>
                        </div>
                        <i class="fa fa-line-chart text-6xl text-[#FF8C00] opacity-50"></i>
                    </div>
                </div>

                <!-- Enrollment Details -->
                <div class="bg-[#2A2A2A] p-6 rounded-lg shadow-md mb-8 fade-in-section">
                    <h3 class="text-2xl font-semibold text-white mb-4 collapsible-header" data-target="enrollment-info-wrapper">
                        <span><i class="fa fa-info-circle text-[#FF8C00] mr-2"></i>Enrollment Information</span>
                        <i class="fa fa-chevron-down toggle-icon text-lg"></i>
                    </h3>
                    <div id="enrollment-info-wrapper" class="hidden">
                        <div class="mb-4">
                            <p class="text-gray-300 font-semibold mb-2">Enrollment Receipt:</p>
                            <a id="enrollment-receipt-link" href="#" target="_blank" class="text-[#60A5FA] hover:underline text-lg flex items-center">
                                <i class="fa fa-external-link mr-2 text-base"></i><span>No receipt URL provided.</span>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- My Courses (Detailed List) -->
                <div class="bg-[#2A2A2A] p-6 rounded-lg shadow-md mb-8 fade-in-section">
                    <h3 class="text-2xl font-semibold text-white mb-4 collapsible-header" data-target="my-courses-list-wrapper">
                        <span><i class="fa fa-graduation-cap text-[#FF8C00] mr-2"></i>My Registered Courses</span>
                        <i class="fa fa-chevron-down toggle-icon text-lg"></i>
                    </h3>
                    <div id="my-courses-list-wrapper" class="hidden">
                        <ul id="my-courses-list" class="space-y-3">
                            <li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg shadow-inner list-item">No courses registered.</li>
                        </ul>
                    </div>
                </div>

                <!-- NEW: Class Timings Section -->
                <div class="bg-[#2A2A2A] p-6 rounded-lg shadow-md mb-8 fade-in-section">
                    <h3 class="text-2xl font-semibold text-white mb-4 section-header-timings collapsible-header" data-target="class-timings-list-wrapper">
                        <span><i class="fa fa-clock-o icon-timings mr-2"></i>My Class Timings</span>
                        <i class="fa fa-chevron-down toggle-icon text-lg"></i>
                    </h3>
                    <div id="class-timings-list-wrapper" class="hidden">
                        <ul id="class-timings-list" class="space-y-3">
                            <li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No class timings available for your enrolled courses.</li>
                        </ul>
                    </div>
                </div>

                <!-- My Assignments -->
                <div class="bg-[#2A2A2A] p-6 rounded-lg shadow-md mb-8 fade-in-section">
                    <h3 class="text-2xl font-semibold text-white mb-4 section-header-assignments collapsible-header" data-target="my-assignments-list-wrapper">
                        <span><i class="fa fa-tasks icon-assignments mr-2"></i>My Assignments</span>
                        <i class="fa fa-chevron-down toggle-icon text-lg"></i>
                    </h3>
                    <div id="my-assignments-list-wrapper" class="hidden"> <!-- Wrapper for toggling -->
                        <ul id="my-assignments-list" class="space-y-3">
                            <li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg shadow-inner list-item">No assignments provided.</li>
                        </ul>
                    </div>
                </div>

                <!-- My Certificates -->
                <div class="bg-[#2A2A2A] p-6 rounded-lg shadow-md mb-8 fade-in-section">
                    <h3 class="text-2xl font-semibold text-white mb-4 collapsible-header" data-target="my-certificates-list-wrapper">
                        <span><i class="fa fa-certificate text-[#10B981] mr-2"></i>My Certificates</span>
                        <i class="fa fa-chevron-down toggle-icon text-lg"></i>
                    </h3>
                    <div id="my-certificates-list-wrapper" class="hidden">
                        <ul id="my-certificates-list" class="space-y-3">
                            <li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg shadow-inner list-item">No certificates provided.</li>
                        </ul>
                    </div>
                </div>

                <!-- My Notes -->
                <div class="bg-[#2A2A2A] p-6 rounded-lg shadow-md mb-8 fade-in-section">
                    <h3 class="text-2xl font-semibold text-white mb-4 collapsible-header" data-target="my-notes-wrapper">
                        <span><i class="fa fa-pencil-square-o icon-notes mr-2"></i>My Notes</span>
                        <i class="fa fa-chevron-down toggle-icon text-lg"></i>
                    </h3>
                    <div id="my-notes-wrapper" class="hidden">
                        <div id="my-notes-content" class="text-gray-300 leading-relaxed mb-3">
                            <p class="text-gray-400 text-center">No notes provided.</p>
                        </div>
                        <p class="text-gray-300 font-semibold mb-2">Notes Attachments:</p>
                        <ul id="my-notes-attachments-list" class="space-y-2">
                            <li class="text-gray-400 text-center text-sm bg-[#1A1A1A] p-3 rounded-lg list-item">No attachments.</li>
                        </ul>
                    </div>
                </div>

                <!-- Recent Activity / Notifications -->
                <div class="bg-[#2A2A2A] p-6 rounded-lg shadow-md mb-8 fade-in-section">
                    <h3 class="text-2xl font-semibold text-white mb-4 collapsible-header" data-target="recent-activity-list-wrapper">
                        <span><i class="fa fa-history text-[#00BCD4] mr-2"></i>Recent Activity</span>
                        <i class="fa fa-chevron-down toggle-icon text-lg"></i>
                    </h3>
                    <div id="recent-activity-list-wrapper" class="hidden">
                        <ul id="recent-activity-list" class="space-y-4">
                            <li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg shadow-inner list-item">No recent activity.</li>
                        </ul>
                    </div>
                </div>

                <!-- Upcoming Deadlines -->
                <div class="bg-[#2A2A2A] p-6 rounded-lg shadow-md mb-8 fade-in-section">
                    <h3 class="text-2xl font-semibold text-white mb-4 collapsible-header" data-target="upcoming-deadlines-list-wrapper">
                        <span><i class="fa fa-hourglass-half text-[#FFC107] mr-2"></i>Upcoming Deadlines</span>
                        <i class="fa fa-chevron-down toggle-icon text-lg"></i>
                    </h3>
                    <div id="upcoming-deadlines-list-wrapper" class="hidden">
                        <ul id="upcoming-deadlines-list" class="space-y-3">
                            <li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg shadow-inner list-item">No upcoming deadlines.</li>
                        </ul>
                    </div>
                </div>

                <!-- NEW: Feedback Section - Renamed and Styled (Admin to Student) -->
                <div class="bg-[#2A2A2A] p-6 rounded-lg shadow-md mb-8 fade-in-section">
                    <h3 class="text-2xl font-semibold text-white mb-4 section-header-feedback collapsible-header" data-target="feedback-list-wrapper">
                        <span><i class="fa fa-comments-o icon-feedback mr-2"></i>Feedback From Teacher</span>
                        <i class="fa fa-chevron-down toggle-icon text-lg"></i>
                    </h3>
                    <div id="feedback-list-wrapper" class="hidden"> <!-- Wrapper for toggling -->
                        <ul id="feedback-list" class="space-y-4"> <!-- Increased space -->
                            <li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No feedback yet.</li>
                        </ul>
                    </div>
                </div>

                <!-- NEW: My Sent Feedback to Admin (with Admin Replies) -->
                <div class="bg-[#2A2A2A] p-6 rounded-lg shadow-md mb-8 fade-in-section">
                    <h3 class="text-2xl font-semibold text-white mb-4 section-header-student-feedback collapsible-header" data-target="my-feedback-list-wrapper">
                        <span><i class="fa fa-commenting icon-student-feedback mr-2"></i>My Sent Feedback to Admin</span>
                        <i class="fa fa-chevron-down toggle-icon text-lg"></i>
                    </h3>
                    <div id="my-feedback-list-wrapper" class="hidden"> <!-- Wrapper for toggling -->
                        <ul id="my-sent-feedback-list" class="space-y-4">
                            <li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No feedback sent yet.</li>
                        </ul>
                    </div>
                </div>


                <!-- NEW: Send Feedback to Admin Section (Student to Admin) -->
                <div class="bg-[#2A2A2A] p-6 rounded-lg shadow-md mb-8 fade-in-section student-feedback-send-card">
                    <h3 class="text-2xl font-semibold text-white mb-4 section-header-student-feedback collapsible-header" data-target="send-feedback-input-wrapper">
                        <span><i class="fa fa-paper-plane icon-student-feedback mr-2"></i>Send New Feedback to Admin</span>
                        <i class="fa fa-chevron-down toggle-icon text-lg"></i>
                    </h3>
                    <div id="send-feedback-input-wrapper" class="hidden"> <!-- Wrapper for toggling -->
                        <textarea id="student-feedback-input" rows="4" class="w-full p-3 rounded-md bg-[#0D0D0D] text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#FACC15]" placeholder="Type your feedback message here..."></textarea>
                        <button id="send-student-feedback-btn" class="w-full action-button font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 mt-4">
                            Send Feedback
                        </button>
                    </div>
                </div>


                <!-- NEW: Attendance History Section -->
                <div class="bg-[#2A2A2A] p-6 rounded-lg shadow-md mb-8 fade-in-section">
                    <h3 class="text-2xl font-semibold text-white mb-4 section-header-attendance collapsible-header" data-target="attendance-content-wrapper">
                        <span><i class="fa fa-check-square-o icon-attendance mr-2"></i>Attendance History</span>
                        <i class="fa fa-chevron-down toggle-icon text-lg"></i>
                    </h3>
                    <div id="attendance-content-wrapper" class="hidden"> <!-- Wrapper for toggling -->
                        <!-- Calendar View for Attendance -->
                        <div id="attendance-calendar-container" class="calendar-container mb-6">
                            <div class="calendar-header">
                                <button id="prev-month-btn">&laquo; Prev</button>
                                <h4 id="current-month-year" class="text-2xl font-semibold"></h4>
                                <button id="next-month-btn">Next &raquo;</button>
                            </div>
                            <div id="calendar-grid" class="calendar-grid">
                                <!-- Day headers -->
                                <div class="calendar-day-header">Sun</div>
                                <div class="calendar-day-header">Mon</div>
                                <div class="calendar-day-header">Tue</div>
                                <div class="calendar-day-header">Wed</div>
                                <div class="calendar-day-header">Thu</div>
                                <div class="calendar-day-header">Fri</div>
                                <div class="calendar-day-header">Sat</div>
                                <!-- Calendar days will be generated here by JS -->
                            </div>
                        </div>

                        <!-- List View for Attendance (Existing) -->
                        <h4 class="text-xl font-semibold text-white mt-8 mb-4">Detailed Attendance List</h4>
                        <ul id="attendance-list" class="space-y-3">
                            <li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No attendance records.</li>
                        </ul>
                    </div>
                </div>

                <!-- NEW: Recorded Sessions Section -->
                <div class="bg-[#2A2A2A] p-6 rounded-lg shadow-md mb-8 fade-in-section">
                    <h3 class="text-2xl font-semibold text-white mb-4 section-header-sessions collapsible-header" data-target="recorded-sessions-list-wrapper">
                        <span><i class="fa fa-video-camera icon-sessions mr-2"></i>Recorded Sessions</span>
                        <i class="fa fa-chevron-down toggle-icon text-lg"></i>
                    </h3>
                    <div id="recorded-sessions-list-wrapper" class="hidden"> <!-- Wrapper for toggling -->
                        <ul id="recorded-sessions-list" class="space-y-3">
                            <li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No recorded sessions.</li>
                        </ul>
                    </div>
                </div>

            </section>
        </main>

        <footer class="mt-12 text-gray-500 text-sm text-center">
            &copy; 2025 Fortitude Frontier. All rights reserved.
        </footer>
    </div>

    <!-- Firebase SDKs -->
    <script type="module" defer>
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, where, getDocs, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

        let app;
        let auth;
        let db;
        let currentUserId = null;
        let currentStudentDocId = null; // Store the Firestore document ID for the student's record
        let enrolledCoursesForTimings = []; // To store the student's enrolled courses for filtering timings

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Using __app_id for Firestore paths

        const firebaseConfig = {
            apiKey: "AIzaSyCqWbcgSdseuGSd6aLBqG76lAyr647xgQ4",
            authDomain: "signup-b09e6.firebaseapp.com",
            projectId: "signup-b09e6",
            storageBucket: "signup-b09e6.appspot.com", // Corrected storageBucket to appspot.com
            messagingSenderId: "203916695845",
            appId: "1:203916695845:web:5310b5ca37c7809be862cc"
        };

        // Initialize Firebase
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        // Variables to hold unsubscribe functions for Firestore listeners
        let unsubscribeProfile = null;
        let unsubscribeStudentRecord = null;
        let unsubscribeClassTimings = null;

        // DOM elements for Student Login Modal
        const studentLoginModal = document.getElementById('student-login-modal');
        const studentLoginCloseButton = document.getElementById('student-login-close-button');
        const studentAuthForm = document.getElementById('student-auth-form');
        const studentEmailInput = document.getElementById('student-email');
        const studentPasswordInput = document.getElementById('student-password');
        const studentLoginBtn = document.getElementById('student-login-btn');
        const studentAuthMessage = document.getElementById('student-auth-message');

        // Main dashboard content
        const dashboardMainContent = document.getElementById('dashboard-main-content');

        // Dashboard content elements
        const currentUserNameDisplay = document.getElementById('current-user-name');
        const currentUserEmailDisplay = document.getElementById('current-user-email-display');
        const studentIdDisplay = document.getElementById('student-id-display').querySelector('span'); // Get the span inside
        const enrollmentDateDisplay = document.getElementById('enrollment-date-display').querySelector('span'); // Get the span inside
        const coursesEnrolledCount = document.getElementById('courses-enrolled-count');
        const assignmentsCount = document.getElementById('assignments-count');
        const overallProgressPercentage = document.getElementById('overall-progress-percentage');
        const recentActivityList = document.getElementById('recent-activity-list');
        const myCoursesList = document.getElementById('my-courses-list');
        const upcomingDeadlinesList = document.getElementById('upcoming-deadlines-list');
        const enrollmentReceiptLink = document.getElementById('enrollment-receipt-link');
        const myAssignmentsList = document.getElementById('my-assignments-list');
        const myCertificatesList = document.getElementById('my-certificates-list');
        const myNotesContent = document.getElementById('my-notes-content'); // Notes text
        const myNotesAttachmentsList = document.getElementById('my-notes-attachments-list'); // Notes URLs list

        // Dashboard sections for Feedback, Attendance, Recorded Sessions, Class Timings
        const feedbackList = document.getElementById('feedback-list'); // Feedback From Teacher (admin_sent_feedback)
        const attendanceList = document.getElementById('attendance-list');
        const recordedSessionsList = document.getElementById('recorded-sessions-list');
        const classTimingsList = document.getElementById('class-timings-list'); // For displaying class timings

        // Student Feedback Send elements
        const studentFeedbackInput = document.getElementById('student-feedback-input');
        const sendStudentFeedbackBtn = document.getElementById('send-student-feedback-btn');

        // My Sent Feedback to Admin elements
        const mySentFeedbackList = document.getElementById('my-sent-feedback-list');

        // Toggle Buttons and Wrappers
        const feedbackListWrapper = document.getElementById('feedback-list-wrapper');
        const myFeedbackListWrapper = document.getElementById('my-feedback-list-wrapper');
        const sendFeedbackInputWrapper = document.getElementById('send-feedback-input-wrapper');
        const myAssignmentsListWrapper = document.getElementById('my-assignments-list-wrapper');
        const attendanceContentWrapper = document.getElementById('attendance-content-wrapper'); // Changed from list-wrapper
        const recordedSessionsListWrapper = document.getElementById('recorded-sessions-list-wrapper');
        const classTimingsListWrapper = document.getElementById('class-timings-list-wrapper');
        const enrollmentInfoWrapper = document.getElementById('enrollment-info-wrapper');
        const myCoursesListWrapper = document.getElementById('my-courses-list-wrapper');
        const myCertificatesListWrapper = document.getElementById('my-certificates-list-wrapper');
        const myNotesWrapper = document.getElementById('my-notes-wrapper');
        const recentActivityListWrapper = document.getElementById('recent-activity-list-wrapper');
        const upcomingDeadlinesListWrapper = document.getElementById('upcoming-deadlines-list-wrapper');

        // Calendar elements
        const currentMonthYearDisplay = document.getElementById('current-month-year');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const calendarGrid = document.getElementById('calendar-grid');

        let currentCalendarDate = new Date(); // To keep track of the month displayed in the calendar
        let allAttendanceData = []; // Store all attendance data to filter by month


        // Navbar user info displays
        const userEmailNavDisplay = document.getElementById('user-email-nav');
        const mobileUserEmailNavDisplay = document.getElementById('mobile-user-nav');

        // Message Box function
        const showMessageBox = (message, onConfirm = null) => {
            const msgBox = document.getElementById('custom-message-box');
            const msgText = document.getElementById('message-box-text');
            const confirmBtn = document.getElementById('message-box-confirm-btn');

            msgText.innerHTML = message;
            confirmBtn.onclick = () => {
                msgBox.classList.remove('show');
                document.body.classList.remove('overflow-hidden');
                if (onConfirm) onConfirm();
            };
            msgBox.classList.add('show');
            document.body.classList.add('overflow-hidden');
        };

        // Function to show/hide modals
        const hideAllModals = () => {
            studentLoginModal.classList.remove('show');
            document.body.classList.remove('overflow-hidden');
        };

        const showStudentLoginModal = () => {
            hideAllModals();
            studentLoginModal.classList.add('show');
            document.body.classList.add('overflow-hidden');
            studentAuthMessage.classList.add('hidden'); // Clear previous messages
        };

        // Close modal listeners
        if (studentLoginCloseButton) {
            studentLoginCloseButton.addEventListener('click', () => hideAllModals());
        }
        if (studentLoginModal) {
            studentLoginModal.addEventListener('click', (e) => {
                if (e.target === studentLoginModal) {
                    hideAllModals();
                }
            });
        }

        /**
         * Generic function to toggle visibility of a section and rotate the icon.
         * @param {HTMLElement} headerElement The clickable header element.
         * @param {HTMLElement} contentWrapperElement The content wrapper to toggle.
         */
        const toggleSectionVisibility = (headerElement, contentWrapperElement) => {
            contentWrapperElement.classList.toggle('hidden');
            headerElement.classList.toggle('collapsed'); // Add/remove 'collapsed' class for icon rotation
        };


        /**
         * Renders the attendance calendar for the given month and year,
         * highlighting dates with attendance records.
         * @param {Date} date The current date (used for month/year).
         * @param {Array} attendanceData All attendance records for the student.
         */
        const renderAttendanceCalendar = (date, attendanceData) => {
            calendarGrid.innerHTML = `
                <div class="calendar-day-header">Sun</div>
                <div class="calendar-day-header">Mon</div>
                <div class="calendar-day-header">Tue</div>
                <div class="calendar-day-header">Wed</div>
                <div class="calendar-day-header">Thu</div>
                <div class="calendar-day-header">Fri</div>
                <div class="calendar-day-header">Sat</div>
            `; // Clear and re-add headers

            const year = date.getFullYear();
            const month = date.getMonth(); // 0-indexed month

            currentMonthYearDisplay.textContent = new Date(year, month).toLocaleString('en-US', { month: 'long', year: 'numeric' });

            const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0 for Sunday, 1 for Monday, etc.
            const daysInMonth = new Date(year, month + 1, 0).getDate(); // Last day of the month

            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;

            // Add empty days for the start of the month
            for (let i = 0; i < firstDayOfMonth; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.classList.add('calendar-day', 'empty');
                calendarGrid.appendChild(emptyDay);
            }

            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.classList.add('calendar-day');

                let status = '';
                let statusClass = '';

                // Check for attendance on this date
                const attendanceRecord = attendanceData.find(record => {
                    const recordDate = new Date(record.date);
                    return recordDate.getFullYear() === year &&
                           recordDate.getMonth() === month &&
                           recordDate.getDate() === day;
                });

                if (attendanceRecord) {
                    status = attendanceRecord.status;
                    statusClass = status.toLowerCase(); // 'present', 'absent', 'late'
                    dayElement.classList.add(statusClass);
                }

                if (isCurrentMonth && day === today.getDate()) {
                    dayElement.classList.add('today');
                }

                dayElement.innerHTML = `
                    <span class="day-number">${day}</span>
                    ${status ? `<span class="attendance-status">${status}</span>` : ''}
                `;
                calendarGrid.appendChild(dayElement);
            }
        };

        // Event listeners for calendar navigation
        prevMonthBtn.addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderAttendanceCalendar(currentCalendarDate, allAttendanceData);
        });

        nextMonthBtn.addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderAttendanceCalendar(currentCalendarDate, allAttendanceData);
        });


        /**
         * Loads and listens for real-time updates to the user's dashboard data from Firestore.
         * @param {string} userId The UID of the currently logged-in user.
         * @param {string} userEmail The email of the currently logged-in user.
         * @returns {object} An object containing unsubscribe functions for the listeners.
         */
        const loadDashboardData = (userId, userEmail) => {
            // Listener for profile data
            const userProfileRef = doc(db, "artifacts", appId, "users", userId, "profile", "details");
            const unsubProfile = onSnapshot(userProfileRef, (docSnap) => {
                console.log("[loadDashboardData] Profile Snapshot (users/profile):", docSnap.exists() ? docSnap.data() : "No profile exists");
                if (docSnap.exists()) {
                    const profileData = docSnap.data();
                    currentUserNameDisplay.textContent = profileData.name || 'Student'; // Display name or fallback
                    currentUserEmailDisplay.textContent = userEmail; // Display email
                } else {
                    console.log("[loadDashboardData] No profile data found for user. Displaying email and setting default.");
                    currentUserNameDisplay.textContent = 'Student'; // Default if no name
                    currentUserEmailDisplay.textContent = userEmail; // Display email
                    // Potentially create a default profile here if desired (e.g., from an admin-added student record)
                    setDoc(userProfileRef, {
                        name: 'Student', // Default name
                        email: userEmail,
                        createdAt: new Date().toISOString() // Ensure timestamp is ISO string
                    }, { merge: true }).catch(e => console.error("Error setting default profile:", e));
                }
            }, (error) => {
                console.error("[loadDashboardData] Error listening to user profile data:", error);
                // Only show message box if user is still actually authenticated for this UID
                if (auth.currentUser && auth.currentUser.uid === userId) {
                    showMessageBox(`Error loading profile data: ${error.message}.`);
                }
            });

            // Listener for student record data from admin panel
            // Query for the student document where the 'uid' matches the authenticated user's UID
            const studentRecordCollectionRef = collection(db, "artifacts", appId, "student_record");
            const studentRecordQuery = query(studentRecordCollectionRef, where("uid", "==", userId));
            console.log("[loadDashboardData] Querying student_record for UID:", userId); // Log the UID being queried

            const unsubStudentRecord = onSnapshot(studentRecordQuery, (querySnapshot) => {
                if (!querySnapshot.empty) {
                    const studentDoc = querySnapshot.docs[0]; // Assuming one student record per UID
                    currentStudentDocId = studentDoc.id; // Store the Firestore document ID
                    const data = studentDoc.data();
                    console.log("[DEBUG] Student record data from snapshot (doc ID:", currentStudentDocId, "):", data); // Detailed debug log

                    // Store enrolled courses globally for class timings filtering
                    enrolledCoursesForTimings = Array.isArray(data.course_enrollment) ? data.course_enrollment : [];
                    console.log("[DEBUG] Enrolled courses for timings:", enrolledCoursesForTimings);
                    loadClassTimingsForStudent(enrolledCoursesForTimings); // Load class timings based on enrolled courses


                    // --- Populate Dashboard UI with data ---
                    studentIdDisplay.textContent = data.student_id || 'N/A';
                    if (data.date_of_enrollment) {
                        try {
                            const enrollmentDate = new Date(data.date_of_enrollment);
                            enrollmentDateDisplay.textContent = enrollmentDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                        } catch (e) {
                            console.error("Error parsing enrollment date:", e);
                            enrollmentDateDisplay.textContent = 'Invalid Date';
                        }
                    } else {
                        enrollmentDateDisplay.textContent = 'N/A';
                    }

                    // NEW: Update "Data Last Updated" timestamp
                    const studentRecordLastUpdated = document.getElementById('student-record-last-updated');
                    if (data.lastUpdated) {
                        try {
                            const lastUpdatedDate = new Date(data.lastUpdated);
                            studentRecordLastUpdated.textContent = `Data Last Updated: ${lastUpdatedDate.toLocaleString()}`;
                        } catch (e) {
                            console.error("Error parsing student record lastUpdated date:", e);
                            studentRecordLastUpdated.textContent = `Data Last Updated: Invalid Date`;
                        }
                    } else {
                        studentRecordLastUpdated.textContent = `Data Last Updated: N/A`;
                    }

                    const enrolledCourses = Array.isArray(data.course_enrollment) ? data.course_enrollment : [];
                    coursesEnrolledCount.textContent = enrolledCourses.length;
                    myCoursesList.innerHTML = '';
                    if (enrolledCourses.length > 0) {
                        enrolledCourses.forEach(course => {
                            const li = document.createElement('li');
                            li.className = "bg-[#1A1A1A] p-4 rounded-lg shadow-inner flex items-center list-item";
                            li.innerHTML = `<i class="fa fa-book text-[#FF8C00] mr-3 text-xl"></i><span class="text-white text-lg">${course}</span>`;
                            myCoursesList.appendChild(li);
                        });
                    } else {
                        myCoursesList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No courses registered.</li>';
                    }

                    const enrollmentReceiptSection = enrollmentReceiptLink.closest('div');
                    if (data.enrollment_receipt_url && data.enrollment_receipt_url.trim() !== '') {
                        enrollmentReceiptLink.href = data.enrollment_receipt_url;
                        enrollmentReceiptLink.querySelector('span').textContent = "View Enrollment Receipt";
                        enrollmentReceiptLink.classList.remove('hidden');
                    } else {
                        enrollmentReceiptLink.querySelector('span').textContent = "No receipt URL provided.";
                        enrollmentReceiptLink.removeAttribute('href');
                        enrollmentReceiptLink.classList.add('hidden');
                    }

                    const assignments = Array.isArray(data.assignments) ? data.assignments : [];
                    assignmentsCount.textContent = assignments.length;
                    myAssignmentsList.innerHTML = '';
                    if (assignments.length > 0) {
                        assignments.forEach((assignment, index) => {
                            const li = document.createElement('li');
                            li.className = "assignment-item-card"; // Apply specific styling
                            const statusClass = assignment.status ? `status-${assignment.status.toLowerCase()}` : 'status-pending';
                            const scoreDisplay = assignment.score !== null ? `${assignment.score}/100` : 'N/A';
                            const assignmentUrlHtml = assignment.url ? `<a href="${assignment.url}" target="_blank" class="assignment-url">View Assignment</a>` : 'No URL provided.';

                            li.innerHTML = `
                                <p class="assignment-title">
                                    <i class="fa fa-file-text-o icon-assignments mr-2"></i>${assignment.description || `Assignment ${index + 1}`}
                                    <span class="status-indicator ${statusClass}">${assignment.status || 'Pending'}</span>
                                </p>
                                <p class="assignment-details">Score: <span class="font-semibold">${scoreDisplay}</span></p>
                                <p class="assignment-details">URL: ${assignmentUrlHtml}</p>
                            `;
                            myAssignmentsList.appendChild(li);
                        });
                    } else {
                        myAssignmentsList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No assignments provided.</li>';
                    }

                    const certificates = Array.isArray(data.certificates) ? data.certificates : [];
                    myCertificatesList.innerHTML = '';
                    if (certificates.length > 0) {
                        certificates.forEach((url, index) => {
                            const li = document.createElement('li');
                            li.className = "bg-[#1A1A1A] p-4 rounded-lg shadow-inner flex items-center list-item";
                            li.innerHTML = `<i class="fa fa-certificate text-[#10B981] mr-3 text-xl"></i><a href="${url}" target="_blank" class="text-white hover:underline transition-colors duration-200 truncate flex-grow">Certificate ${index + 1}</a>`;
                            myCertificatesList.appendChild(li);
                        });
                    } else {
                        myCertificatesList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No certificates provided.</li>';
                    }

                    // Debug log for overall_progress
                    console.log("[DEBUG] overall_progress (from snapshot):", data.overall_progress);
                    overallProgressPercentage.textContent = data.overall_progress !== null ? `${data.overall_progress}%` : 'N/A';

                    const notes = data.notes || '';
                    myNotesContent.innerHTML = '';
                    if (notes.trim() !== '') {
                        myNotesContent.innerHTML = `<p>${notes}</p>`;
                    } else {
                        myNotesContent.innerHTML = '<p class="text-gray-400 text-center">No notes provided by admin.</p>';
                    }

                    const notesAttachments = Array.isArray(data.notes_attachments) ? data.notes_attachments : [];
                    myNotesAttachmentsList.innerHTML = '';
                    if (notesAttachments.length > 0) {
                        notesAttachments.forEach((url, index) => {
                            const li = document.createElement('li');
                            li.className = "flex items-center text-sm text-gray-300 bg-[#1A1A1A] p-3 rounded-lg list-item";
                            li.innerHTML = `<i class="fa fa-link text-[#60A5FA] mr-2"></i><a href="${url}" target="_blank" class="hover:underline truncate">${url}</a>`;
                            myNotesAttachmentsList.appendChild(li);
                        });
                    } else {
                        myNotesAttachmentsList.innerHTML = '<li class="text-gray-400 text-center text-sm bg-[#1A1A1A] p-3 rounded-lg list-item">No attachments.</li>';
                    }

                    const upcomingDeadlines = Array.isArray(data.upcoming_deadlines) ? data.upcoming_deadlines : [];
                    upcomingDeadlinesList.innerHTML = '';
                    if (upcomingDeadlines.length > 0) {
                        upcomingDeadlines.forEach(item => {
                            const li = document.createElement('li');
                            li.className = "bg-[#1A1A1A] p-4 rounded-lg shadow-inner flex items-center list-item";
                            li.innerHTML = `<i class="fa fa-calendar text-[#FFC107] mr-3 text-xl"></i><span class="text-white">${item}</span>`;
                            upcomingDeadlinesList.appendChild(li);
                        });
                    } else {
                        upcomingDeadlinesList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No upcoming deadlines.</li>';
                    }

                    const recentActivity = Array.isArray(data.recent_activity) ? data.recent_activity : [];
                    recentActivityList.innerHTML = '';
                    if (recentActivity.length > 0) {
                        recentActivity.forEach(item => {
                            const li = document.createElement('li');
                            li.className = "bg-[#1A1A1A] p-4 rounded-lg shadow-inner flex items-center list-item";
                            li.innerHTML = `<i class="fa fa-history text-[#00BCD4] mr-3 text-xl"></i><span class="text-white">${item}</span>`;
                            recentActivityList.appendChild(li);
                        });
                    } else {
                        recentActivityList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No recent activity.</li>';
                    }

                    // Populate Feedback From Teacher (admin_sent_feedback)
                    console.log("[DEBUG] admin_sent_feedback (from snapshot):", data.admin_sent_feedback); // Debug log
                    const adminSentFeedback = Array.isArray(data.admin_sent_feedback) ? data.admin_sent_feedback : [];
                    feedbackList.innerHTML = '';
                    if (adminSentFeedback.length > 0) {
                        adminSentFeedback.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        adminSentFeedback.forEach(item => {
                            const li = document.createElement('li');
                            li.className = "feedback-item-card";
                            const feedbackDate = new Date(item.timestamp).toLocaleString();
                            li.innerHTML = `
                                <p class="feedback-text">${item.text}</p>
                                <p class="feedback-timestamp">Sent: ${feedbackDate}</p>
                            `;
                            feedbackList.appendChild(li);
                        });
                    } else {
                        feedbackList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No feedback yet.</li>';
                    }

                    // Populate My Sent Feedback to Admin (student_feedback_received)
                    console.log("[DEBUG] student_feedback_received (from snapshot):", data.student_feedback_received); // Debug log
                    const studentFeedbackReceived = Array.isArray(data.student_feedback_received) ? data.student_feedback_received : [];
                    mySentFeedbackList.innerHTML = '';
                    if (studentFeedbackReceived.length > 0) {
                        studentFeedbackReceived.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Sort by newest first
                        studentFeedbackReceived.forEach((item, index) => {
                            const li = document.createElement('li');
                            li.className = "feedback-item-card"; // Re-use styling
                            li.style.borderLeftColor = '#FACC15'; // Amber border for sent feedback
                            li.innerHTML = `
                                <p class="feedback-text"><i class="fa fa-user-circle-o text-gray-400 mr-2"></i>You: ${item.text}</p>
                                <p class="feedback-timestamp">Sent: ${new Date(item.timestamp).toLocaleString()}</p>
                            `;
                            // Add admin replies if they exist
                            if (Array.isArray(item.replies) && item.replies.length > 0) {
                                let repliesHtml = '<div class="mt-3 space-y-2">';
                                item.replies.forEach(reply => {
                                    repliesHtml += `
                                        <div class="admin-reply-card">
                                            <p><i class="fa fa-graduation-cap text-blue-300 mr-2"></i>Admin: ${reply.text}</p>
                                            <p class="reply-timestamp">Replied: ${new Date(reply.timestamp).toLocaleString()}</p>
                                        </div>
                                    `;
                                });
                                repliesHtml += '</div>';
                                li.innerHTML += repliesHtml;
                            }
                            mySentFeedbackList.appendChild(li);
                        });
                    } else {
                        mySentFeedbackList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No feedback sent yet.</li>';
                    }

                    // Handle attendance data for both list and calendar
                    allAttendanceData = Array.isArray(data.attendance) ? data.attendance : [];
                    attendanceList.innerHTML = ''; // Clear previous list entries
                    if (allAttendanceData.length > 0) {
                        allAttendanceData.sort((a, b) => new Date(b.date) - new Date(a.date));
                        allAttendanceData.forEach(item => {
                            const li = document.createElement('li');
                            li.className = "bg-[#1A1A1A] p-4 rounded-lg shadow-inner flex items-center list-item";
                            const attendanceDate = new Date(item.date).toLocaleDateString();
                            const statusColor = item.status === 'Present' ? 'status-present' : item.status === 'Absent' ? 'status-absent' : 'status-late';
                            li.innerHTML = `
                                <i class="fa fa-calendar-check-o icon-attendance mr-3 text-xl"></i>
                                <span class="text-white">Date: ${attendanceDate}</span>
                                <span class="ml-auto ${statusColor} font-semibold">${item.status}</span>
                            `;
                            attendanceList.appendChild(li);
                        });
                    } else {
                        attendanceList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No attendance records.</li>';
                    }
                    // Render calendar with all attendance data
                    renderAttendanceCalendar(currentCalendarDate, allAttendanceData);


                    const recordedSessions = Array.isArray(data.recorded_sessions) ? data.recorded_sessions : [];
                    recordedSessionsList.innerHTML = '';
                    if (recordedSessions.length > 0) {
                        recordedSessions.sort((a, b) => new Date(b.date) - new Date(a.date));
                        recordedSessions.forEach((sessionObj, index) => {
                            const li = document.createElement('li');
                            li.className = "bg-[#1A1A1A] p-4 rounded-lg shadow-inner flex flex-col sm:flex-row sm:items-center list-item";
                            const displayDate = new Date(sessionObj.date).toLocaleDateString();
                            li.innerHTML = `
                                <i class="fa fa-play-circle-o icon-sessions mr-3 text-xl"></i>
                                <span class="text-white mr-2">Session on ${displayDate}:</span>
                                <a href="${sessionObj.url}" target="_blank" class="text-[#EAB308] hover:underline transition-colors duration-200 truncate flex-grow mt-2 sm:mt-0">${sessionObj.url}</a>
                            `;
                            recordedSessionsList.appendChild(li);
                        });
                    } else {
                        recordedSessionsList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No recorded sessions.</li>';
                    }

                } else {
                    console.warn("[loadDashboardData] No student record found for this user in 'student_record' collection. Resetting dashboard UI.");
                    currentStudentDocId = null; // Ensure it's null if no record is found
                    enrolledCoursesForTimings = []; // Clear enrolled courses if no record
                    loadClassTimingsForStudent([]); // Clear class timings display

                    // --- Reset Dashboard UI to default states ---
                    studentIdDisplay.textContent = 'N/A';
                    enrollmentDateDisplay.textContent = 'N/A';
                    document.getElementById('student-record-last-updated').textContent = `Data Last Updated: N/A`; // Reset last updated
                    coursesEnrolledCount.textContent = '0';
                    assignmentsCount.textContent = '0';
                    overallProgressPercentage.textContent = 'N/A';
                    enrollmentReceiptLink.textContent = "No receipt URL provided.";
                    enrollmentReceiptLink.removeAttribute('href');
                    enrollmentReceiptLink.classList.add('hidden');
                    myCoursesList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No courses registered.</li>';
                    myAssignmentsList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No assignments provided.</li>';
                    myCertificatesList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No certificates provided.</li>';
                    myNotesContent.innerHTML = '<p class="text-gray-400 text-center">No notes provided by admin.</p>';
                    myNotesAttachmentsList.innerHTML = '<li class="text-gray-400 text-center text-sm list-item">No attachments.</li>';
                    recentActivityList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No recent activity.</li>';
                    upcomingDeadlinesList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No upcoming deadlines.</li>';
                    feedbackList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No feedback yet.</li>';
                    mySentFeedbackList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No feedback sent yet.</li>';

                    allAttendanceData = []; // Clear attendance data
                    attendanceList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No attendance records.</li>';
                    renderAttendanceCalendar(currentCalendarDate, allAttendanceData); // Re-render empty calendar

                    recordedSessionsList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No recorded sessions.</li>';
                }
            }, (error) => {
                console.error("[loadDashboardData] Error listening to student record data:", error);
                if (auth.currentUser && auth.currentUser.uid === userId) {
                    showMessageBox(`Error loading student data: ${error.message}.`);
                }
            });
            return { unsubscribeProfile: unsubProfile, unsubscribeStudentRecord: unsubStudentRecord };
        };

        /**
         * Loads and displays class timings based on the student's enrolled courses.
         * It listens to the public 'class_timings' document in Firestore.
         * @param {string[]} enrolledCourses An array of course names the student is enrolled in.
         */
        async function loadClassTimingsForStudent(enrolledCourses) {
            console.log("[loadClassTimingsForStudent] Loading timings for enrolled courses:", enrolledCourses);
            if (unsubscribeClassTimings) {
                unsubscribeClassTimings(); // Unsubscribe from previous listener if exists
                unsubscribeClassTimings = null;
            }

            const timingsDocRef = doc(db, "artifacts", appId, "public", "data", "class_timings", "daily_timings");
            classTimingsList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">Loading class timings...</li>';

            unsubscribeClassTimings = onSnapshot(timingsDocRef, (docSnap) => {
                classTimingsList.innerHTML = ''; // Clear previous entries

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const allTimings = Array.isArray(data.timings) ? data.timings : [];
                    console.log("[DEBUG] All loaded class timings from public document:", allTimings);

                    // Filter timings by enrolled courses
                    const filteredTimings = allTimings.filter(timing => {
                        // Check if the class name (e.g., "Python Basics") contains any of the enrolled course names (e.g., "Python")
                        // This assumes "Class Name" in admin panel is descriptive and includes the course name
                        return enrolledCourses.some(course =>
                            timing.name && timing.name.toLowerCase().includes(course.toLowerCase())
                        );
                    });
                    console.log("[DEBUG] Filtered class timings for student's courses:", filteredTimings);

                    if (filteredTimings.length > 0) {
                        // Sort filtered timings by date, then by start time
                        filteredTimings.sort((a, b) => {
                            const dateA = new Date(a.date);
                            const dateB = new Date(b.date);
                            if (dateA.getTime() === dateB.getTime()) {
                                return a.start.localeCompare(b.start);
                            }
                            return dateA - dateB;
                        });

                        filteredTimings.forEach(timing => {
                            const li = document.createElement('li');
                            li.className = "class-timing-item flex flex-col list-item";
                            const displayDate = new Date(timing.date).toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
                            li.innerHTML = `
                                <div class="flex items-center mb-1">
                                    <i class="fa fa-calendar-o icon-timings mr-2 text-xl"></i>
                                    <p class="class-name">${timing.name}</p>
                                </div>
                                <p class="class-details ml-7">Date: ${displayDate}</p>
                                <p class="class-details ml-7">Time: ${timing.start} - ${timing.end}</p>
                            `;
                            classTimingsList.appendChild(li);
                        });
                    } else {
                        classTimingsList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No class timings available for your enrolled courses.</li>';
                    }
                } else {
                    console.log("[loadClassTimingsForStudent] No public class timings document found.");
                    classTimingsList.innerHTML = '<li class="text-gray-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">No class timings available for your enrolled courses.</li>';
                }
            }, (error) => {
                console.error("[loadClassTimingsForStudent] Error listening to class timings:", error);
                classTimingsList.innerHTML = `<li class="text-red-400 text-center bg-[#1A1A1A] p-4 rounded-lg list-item">Error loading class timings: ${error.message}</li>`;
            });
        }


        // Student Login Form Submission
        if (studentAuthForm) {
            studentAuthForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = studentEmailInput.value;
                const password = studentPasswordInput.value;
                studentAuthMessage.classList.add('hidden');

                try {
                    console.log("[Login] Attempting student sign-in with email:", email);
                    await signInWithEmailAndPassword(auth, email, password);
                    showMessageBox("Logged in successfully as student!");
                    hideAllModals();
                } catch (error) {
                    console.error("[Login] Student Login error:", error.code, error.message);
                    let errorMessage = `Login failed: ${error.message}.`;
                    if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        errorMessage = "Invalid email or password. Please check your student credentials.";
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = "Invalid email format for student login.";
                    } else if (error.code === 'auth/too-many-requests') {
                        errorMessage = "Too many failed login attempts. Please try again later.";
                    } else {
                        errorMessage = `An unexpected error occurred during student login: ${error.message}.`;
                    }
                    studentAuthMessage.textContent = errorMessage;
                    studentAuthMessage.classList.remove('hidden');
                }
            });
        }

        // Send Feedback to Admin functionality
        if (sendStudentFeedbackBtn) {
            sendStudentFeedbackBtn.addEventListener('click', async () => {
                const feedbackText = studentFeedbackInput.value.trim();

                if (!feedbackText) {
                    showMessageBox("Please enter your feedback before sending.");
                    return;
                }

                console.log("[Send Feedback] currentUserId:", currentUserId);
                console.log("[Send Feedback] currentStudentDocId:", currentStudentDocId);

                if (!currentUserId) {
                    showMessageBox("You must be logged in as a student to send feedback.");
                    console.error("[Send Feedback] currentUserId is null. User not authenticated.");
                    return;
                }
                if (!currentStudentDocId) {
                    showMessageBox("Your student record could not be found. Please contact support.");
                    console.error("[Send Feedback] currentStudentDocId is null. Student record not loaded or does not exist for this UID.");
                    return;
                }

                const studentDocRef = doc(db, "artifacts", appId, "student_record", currentStudentDocId);
                console.log("[Send Feedback] Targeting Firestore document path:", studentDocRef.path);

                try {
                    // Before attempting update, let's explicitly get the document to log its current state,
                    // especially the 'uid' field to verify rule conditions.
                    const docSnap = await getDoc(studentDocRef);
                    if (!docSnap.exists()) {
                        console.error("[Send Feedback] Document does not exist at:", studentDocRef.path);
                        showMessageBox("Your student record does not exist. Please contact support.");
                        return;
                    }
                    const docData = docSnap.data();
                    console.log("[Send Feedback] Data of target document BEFORE update:", docData);
                    console.log("[Send Feedback] UID in target document (resource.data.uid):", docData.uid);
                    console.log("[Send Feedback] Authenticated UID (request.auth.uid):", auth.currentUser.uid);


                    await updateDoc(studentDocRef, {
                        student_feedback_received: arrayUnion({
                            text: feedbackText,
                            timestamp: new Date().toISOString(),
                            from: "student", // Indicate sender
                            replies: [] // Initialize with empty replies array for future admin replies
                        }),
                        lastUpdated: new Date().toISOString() // Update general last updated timestamp on student record
                    });
                    showMessageBox("Feedback sent successfully to admin!");
                    studentFeedbackInput.value = ''; // Clear input
                    console.log("[Send Feedback] Successfully updated document.");
                } catch (err) {
                    console.error("[Send Feedback] Error sending student feedback:", err.message, "Code:", err.code);
                    showMessageBox(`Error sending feedback: ${err.message}`);
                }
            });
        }


        // OnAuthStateChanged listener to handle user state and show/hide dashboard
        onAuthStateChanged(auth, (user) => {
            const logoutBtn = document.getElementById('logout-btn');
            const mobileLogoutBtn = document.getElementById('mobile-logout-btn');
            const userInfoDisplay = document.getElementById('user-info');
            const mobileUserInfoDisplay = document.getElementById('mobile-user-info');

            if (user) {
                currentUserId = user.uid;
                console.log("[onAuthStateChanged] User logged in. UID:", user.uid, "Email:", user.email);

                if (userEmailNavDisplay) userEmailNavDisplay.textContent = user.email || '';
                if (mobileUserEmailNavDisplay) mobileUserEmailNavDisplay.textContent = user.email || '';

                if (userInfoDisplay) userInfoDisplay.classList.remove('hidden');
                if (mobileUserInfoDisplay) mobileUserInfoDisplay.classList.remove('hidden');

                dashboardMainContent.classList.remove('hidden');
                const unsubs = loadDashboardData(currentUserId, user.email || 'N/A');
                unsubscribeProfile = unsubs.unsubscribeProfile;
                unsubscribeStudentRecord = unsubs.unsubscribeStudentRecord;
                // loadDashboardData handles class timings listener subscription
                hideAllModals();
            } else {
                console.log("[onAuthStateChanged] User logged out or not authenticated.");
                currentUserId = null;
                currentStudentDocId = null;
                enrolledCoursesForTimings = []; // Clear enrolled courses on logout

                if (userEmailNavDisplay) userEmailNavDisplay.textContent = '';
                if (mobileUserEmailNavDisplay) mobileUserEmailNavDisplay.textContent = '';

                if (userInfoDisplay) userInfoDisplay.classList.add('hidden');
                if (mobileUserInfoDisplay) mobileUserInfoDisplay.classList.add('hidden');

                dashboardMainContent.classList.add('hidden');
                showStudentLoginModal();

                // Unsubscribe all active listeners on logout
                if (unsubscribeProfile) {
                    unsubscribeProfile();
                    unsubscribeProfile = null;
                }
                if (unsubscribeStudentRecord) {
                    unsubscribeStudentRecord();
                    unsubscribeStudentRecord = null;
                }
                if (unsubscribeClassTimings) {
                    unsubscribeClassTimings();
                    unsubscribeClassTimings = null;
                }
            }
        });

        // Intersection Observer for fade-in sections
        const observerOptions = {
            root: null, /* viewport */
            rootMargin: '0px',
            threshold: 0.1 /* element is 10% visible */
        };

        const observer = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('is-visible');
                    observer.unobserve(entry.target);
                }
            });
        }, observerOptions);

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.fade-in-section').forEach(section => {
                observer.observe(section);
            });

            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const closeMobileMenuButton = document.getElementById('close-mobile-menu');
            const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');

            if (mobileMenuButton) {
                mobileMenuButton.addEventListener('click', () => {
                    mobileMenuOverlay.classList.remove('hidden');
                    document.body.classList.add('overflow-hidden');
                });
            }

            if (closeMobileMenuButton) {
                closeMobileMenuButton.addEventListener('click', () => {
                    mobileMenuOverlay.classList.add('hidden');
                    document.body.classList.remove('overflow-hidden');
                });
            }

            // Logout logic for this page
            const logoutBtn = document.getElementById('logout-btn');
            const mobileLogoutBtn = document.getElementById('mobile-logout-btn');

            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    try {
                        await signOut(auth);
                        showMessageBox("Logged out successfully! Redirecting to homepage.", () => {
                            window.location.href = 'index.html';
                        });
                    } catch (error) {
                        console.error('Logout error:', error);
                        showMessageBox(`Logout failed: ${error.message}`);
                    }
                });
            }

            if (mobileLogoutBtn) {
                mobileLogoutBtn.addEventListener('click', async () => {
                    try {
                        await signOut(auth);
                        showMessageBox("Logged out successfully! Redirecting to homepage.", () => {
                            mobileMenuOverlay.classList.add('hidden');
                            document.body.classList.remove('overflow-hidden');
                            window.location.href = 'index.html';
                        });
                    } catch (error) {
                        console.error('Mobile logout error:', error);
                        showMessageBox(`Mobile logout failed: ${error.message}`);
                    }
                });
            }

            // Listeners for all collapsible headers
            const collapsibleHeaders = document.querySelectorAll('.collapsible-header');
            collapsibleHeaders.forEach(header => {
                // Initialize header as collapsed
                header.classList.add('collapsed');

                // Get the target content wrapper using the data-target attribute
                const targetId = header.getAttribute('data-target');
                const targetElement = document.getElementById(targetId);

                // Hide the target content wrapper initially
                if (targetElement) {
                    targetElement.classList.add('hidden');
                }

                header.addEventListener('click', () => {
                    if (targetElement) {
                        toggleSectionVisibility(header, targetElement);
                    }
                });
            });
        });
    </script>
</body>
</html>
